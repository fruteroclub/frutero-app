import db from '@/server/clients/db'
import {
  CreateUserInput,
  createUserSchema,
  ProfileFormValues,
} from '@/server/schema/user-services-schema'
import { AppError } from '@/server/utils'
import { UserExtended } from '@/types/api-v1'
import { User } from '@prisma/client'
import { z } from 'zod'

export class UserController {
  static async findAll(): Promise<UserExtended[]> {
    try {
      const users = await db.user.findMany({
        include: {
          profile: true,
          proofOfCommunity: true,
          communities: true,
          projects: true,
          quests: true,
          claimedBadges: true,
        },
      })
      return users as UserExtended[]
    } catch (error) {
      console.error('Error finding users:', error)
      throw new AppError('Failed to fetch users', 500)
    }
  }

  static async findById(id: string): Promise<UserExtended | null> {
    try {
      const user = await db.user.findUnique({
        where: { id },
        include: {
          profile: true,
          proofOfCommunity: {
            include: {
              userBadges: {
                include: {
                  badge: {
                    include: {
                      quest: true,
                    },
                  },
                  tierReached: true,
                },
              },
            },
          },
          communities: true,
          projects: true,
          quests: true,
          claimedBadges: true,
        },
      })

      return user as UserExtended
    } catch (error) {
      console.error('Error finding user:', error)
      throw new AppError('Failed to fetch user', 500)
    }
  }

  static async findByAddress(address: string): Promise<User | null> {
    try {
      const user = await db.user.findFirst({
        where: {
          OR: [{ appWallet: address }, { extWallet: address }],
        },
      })

      return user
    } catch (error) {
      console.error('Error finding user:', error)
      throw new AppError('Failed to fetch user', 500)
    }
  }

  static async findOrCreate(input: CreateUserInput): Promise<UserExtended> {
    try {
      // Validate input
      const validatedData = createUserSchema.parse(input)

      // Try to find existing user
      const existingUser = await db.user.findUnique({
        where: {
          id: input.id,
        },
        include: {
          profile: true,
          proofOfCommunity: {
            include: {
              userBadges: {
                include: {
                  badge: {
                    include: {
                      quest: true,
                    },
                  },
                  tierReached: true,
                },
              },
            },
          },
          communities: true,
          projects: true,
          quests: true,
          claimedBadges: true,
        },
      })

      if (existingUser) return existingUser as UserExtended

      // Create new user if not found
      const newUser = await db.user.create({
        data: {
          username: validatedData.appWallet,
          ...validatedData,
        },
        include: {
          profile: true,
          proofOfCommunity: true,
          communities: true,
          projects: true,
          quests: true,
          claimedBadges: true,
        },
      })

      return newUser as UserExtended
    } catch (error) {
      console.error('Error in findOrCreate:', error)

      if (error instanceof z.ZodError) {
        throw new AppError('Invalid input data', 400, {
          code: 'VALIDATION_ERROR',
          details: error.errors,
        })
      }

      throw new AppError('Failed to create user', 500)
    }
  }

  static async updateUser(
    id: string,
    data: Partial<CreateUserInput>,
  ): Promise<User> {
    try {
      const updatedUser = await db.user.update({
        where: { id },
        data,
      })

      return updatedUser
    } catch (error) {
      console.error('Error updating user:', error)
      throw new AppError('Failed to update user', 500)
    }
  }

  static async updateUserProfile(
    id: string,
    data: Partial<ProfileFormValues>,
  ): Promise<UserExtended> {
    try {
      const updatedUser = await db.user.update({
        where: { id },
        data: {
          profile: {
            upsert: {
              create: {
                firstName: data.firstName,
                lastName: data.lastName,
                cityRegion: data.cityRegion,
                country: data.country,
                primaryRole: data.primaryRole,
                professionalProfile: data.professionalProfile,
                isStudent: data.isStudent ?? false,
              },
              update: {
                firstName: data.firstName,
                lastName: data.lastName,
                cityRegion: data.cityRegion,
                country: data.country,
                primaryRole: data.primaryRole,
                professionalProfile: data.professionalProfile,
                isStudent: data.isStudent ?? false,
              },
            },
          },
        },
        include: {
          profile: true,
        },
      })

      return updatedUser as UserExtended
    } catch (error) {
      console.error('Error updating user profile:', error)
      throw new AppError('Failed to update user profile', 500)
    }
  }

  static async updateUserFarcasterAccount(
    id: string,
    data: {
      farcasterId: number
      farcasterDisplayName: string
      farcasterUsername: string
      farcasterAvatarUrl: string
    },
  ): Promise<UserExtended> {
    try {
      const updatedUser = await db.user.update({
        where: { id },
        data: {
          avatarUrl: data.farcasterAvatarUrl,
          displayName: data.farcasterDisplayName,
          username: data.farcasterUsername.replace(/^@/, ''),
          profile: {
            upsert: {
              create: {
                farcasterId: data.farcasterId,
                farcasterUsername: data.farcasterUsername,
              },
              update: {
                farcasterId: data.farcasterId,
                farcasterUsername: data.farcasterUsername,
              },
            },
          },
        },
        include: {
          profile: true,
        },
      })

      return updatedUser as UserExtended
    } catch (error) {
      console.error('Error updating user profile:', error)
      throw new AppError('Failed to update user profile', 500)
    }
  }

  static async deleteUser(id: string): Promise<boolean> {
    try {
      await db.user.delete({
        where: { id },
      })

      return true
    } catch (error) {
      console.error('Error deleting user:', error)
      throw new AppError('Failed to delete user', 500)
    }
  }
}
