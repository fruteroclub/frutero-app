# JAM-021: Project Team Management

**Priority**: ðŸ”´ Critical
**Effort**: 3-4 hours
**Dependencies**: JAM-004 (project system)

## ðŸ“‹ Objective

Build a team management system for projects, allowing project admins to add/remove team members, manage roles, and view team contributions. Projects serve as team containers for collaborative quest completion.

## âœ… Acceptance Criteria

- [ ] Project admin can view all team members
- [ ] Admin can invite users to join project
- [ ] Admin can remove team members
- [ ] Admin can promote/demote member roles (ADMIN/MEMBER)
- [ ] Members can leave projects
- [ ] Team member list shows roles and join dates
- [ ] Only admins can modify team membership

## ðŸ› ï¸ Implementation

### Files to Create/Modify
- `src/app/jam/projects/[id]/team/page.tsx` - Team management page
- `src/components/jam-platform/projects/TeamManager.tsx` - Team UI
- `src/components/jam-platform/projects/InviteMemberDialog.tsx` - Invite modal
- `src/app/api/jam/projects/[id]/members/route.ts` - Team API

### Team Management Page

```tsx
// src/app/jam/projects/[id]/team/page.tsx
export default async function TeamPage({ params }: { params: { id: string } }) {
  const project = await getProject(params.id);
  const members = await getProjectMembers(params.id);
  const currentUser = await getCurrentUser();

  const isAdmin = members.find(
    m => m.userId === currentUser.id && m.role === 'ADMIN'
  );

  return (
    <div className="container max-w-4xl py-6">
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-3xl font-bold">{project.name} - Team</h1>
          <p className="text-muted-foreground">
            {members.length} team {members.length === 1 ? 'member' : 'members'}
          </p>
        </div>

        {isAdmin && (
          <InviteMemberButton projectId={project.id} />
        )}
      </div>

      <TeamMemberList
        members={members}
        projectId={project.id}
        currentUserId={currentUser.id}
        isAdmin={!!isAdmin}
      />
    </div>
  );
}
```

### Team Member List Component

```tsx
// src/components/jam-platform/projects/TeamMemberList.tsx
'use client';

import { useState } from 'react';
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu';
import { MoreVertical, UserMinus, Crown, User } from 'lucide-react';

interface TeamMember {
  userId: string;
  role: 'ADMIN' | 'MEMBER';
  joinedAt: Date;
  user: {
    id: string;
    displayName: string;
    avatarUrl?: string;
    email?: string;
  };
}

export function TeamMemberList({
  members,
  projectId,
  currentUserId,
  isAdmin
}: {
  members: TeamMember[];
  projectId: string;
  currentUserId: string;
  isAdmin: boolean;
}) {
  const [loading, setLoading] = useState<string | null>(null);

  const handleRemoveMember = async (userId: string) => {
    if (!confirm('Remove this member from the team?')) return;

    setLoading(userId);
    try {
      await fetch(`/api/jam/projects/${projectId}/members/${userId}`, {
        method: 'DELETE',
      });
      window.location.reload(); // Refresh to show updated list
    } catch (error) {
      console.error('Failed to remove member:', error);
    } finally {
      setLoading(null);
    }
  };

  const handleChangeRole = async (userId: string, newRole: 'ADMIN' | 'MEMBER') => {
    setLoading(userId);
    try {
      await fetch(`/api/jam/projects/${projectId}/members/${userId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ role: newRole }),
      });
      window.location.reload();
    } catch (error) {
      console.error('Failed to update role:', error);
    } finally {
      setLoading(null);
    }
  };

  return (
    <div className="space-y-2">
      {members.map((member) => {
        const isCurrentUser = member.userId === currentUserId;
        const canModify = isAdmin && !isCurrentUser;

        return (
          <Card key={member.userId}>
            <CardContent className="p-4">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <Avatar>
                    <AvatarImage src={member.user.avatarUrl} />
                    <AvatarFallback>
                      {member.user.displayName.slice(0, 2).toUpperCase()}
                    </AvatarFallback>
                  </Avatar>

                  <div>
                    <div className="flex items-center gap-2">
                      <span className="font-medium">
                        {member.user.displayName}
                      </span>
                      {isCurrentUser && (
                        <Badge variant="outline" className="text-xs">
                          You
                        </Badge>
                      )}
                    </div>
                    <p className="text-sm text-muted-foreground">
                      Joined {new Date(member.joinedAt).toLocaleDateString()}
                    </p>
                  </div>
                </div>

                <div className="flex items-center gap-2">
                  <Badge
                    variant={member.role === 'ADMIN' ? 'default' : 'secondary'}
                  >
                    {member.role === 'ADMIN' ? (
                      <><Crown className="h-3 w-3 mr-1" /> Admin</>
                    ) : (
                      <><User className="h-3 w-3 mr-1" /> Member</>
                    )}
                  </Badge>

                  {canModify && (
                    <DropdownMenu>
                      <DropdownMenuTrigger asChild>
                        <Button
                          variant="ghost"
                          size="sm"
                          disabled={loading === member.userId}
                        >
                          <MoreVertical className="h-4 w-4" />
                        </Button>
                      </DropdownMenuTrigger>
                      <DropdownMenuContent align="end">
                        {member.role === 'MEMBER' ? (
                          <DropdownMenuItem
                            onClick={() => handleChangeRole(member.userId, 'ADMIN')}
                          >
                            <Crown className="h-4 w-4 mr-2" />
                            Promote to Admin
                          </DropdownMenuItem>
                        ) : (
                          <DropdownMenuItem
                            onClick={() => handleChangeRole(member.userId, 'MEMBER')}
                          >
                            <User className="h-4 w-4 mr-2" />
                            Demote to Member
                          </DropdownMenuItem>
                        )}
                        <DropdownMenuItem
                          onClick={() => handleRemoveMember(member.userId)}
                          className="text-destructive"
                        >
                          <UserMinus className="h-4 w-4 mr-2" />
                          Remove from Team
                        </DropdownMenuItem>
                      </DropdownMenuContent>
                    </DropdownMenu>
                  )}

                  {isCurrentUser && !isAdmin && (
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => handleRemoveMember(currentUserId)}
                      disabled={loading === currentUserId}
                    >
                      Leave Team
                    </Button>
                  )}
                </div>
              </div>
            </CardContent>
          </Card>
        );
      })}
    </div>
  );
}
```

### Invite Member Dialog

```tsx
// src/components/jam-platform/projects/InviteMemberDialog.tsx
'use client';

import { useState } from 'react';
import { Button } from '@/components/ui/button';
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { UserPlus } from 'lucide-react';

export function InviteMemberButton({ projectId }: { projectId: string }) {
  const [open, setOpen] = useState(false);
  const [userId, setUserId] = useState('');
  const [loading, setLoading] = useState(false);

  const handleInvite = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const response = await fetch(`/api/jam/projects/${projectId}/members`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId, role: 'MEMBER' }),
      });

      if (response.ok) {
        setOpen(false);
        setUserId('');
        window.location.reload();
      } else {
        const error = await response.json();
        alert(error.message || 'Failed to add member');
      }
    } catch (error) {
      console.error('Failed to invite member:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button>
          <UserPlus className="h-4 w-4 mr-2" />
          Add Member
        </Button>
      </DialogTrigger>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Add Team Member</DialogTitle>
          <DialogDescription>
            Invite a user to join your project team
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleInvite} className="space-y-4">
          <div>
            <Label htmlFor="userId">User ID or Email</Label>
            <Input
              id="userId"
              value={userId}
              onChange={(e) => setUserId(e.target.value)}
              placeholder="did:privy:... or user@example.com"
              required
            />
            <p className="text-xs text-muted-foreground mt-1">
              Enter the user's Privy ID or email address
            </p>
          </div>

          <div className="flex gap-2">
            <Button
              type="button"
              variant="outline"
              onClick={() => setOpen(false)}
              disabled={loading}
            >
              Cancel
            </Button>
            <Button type="submit" disabled={loading}>
              {loading ? 'Adding...' : 'Add Member'}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}
```

### Team API Routes

```typescript
// src/app/api/jam/projects/[id]/members/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/db';
import { projectMembers, projects } from '@/db/schema';
import { eq, and } from 'drizzle-orm';

// GET /api/jam/projects/:id/members - List team members
export async function GET(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const members = await db
    .select()
    .from(projectMembers)
    .where(eq(projectMembers.projectId, params.id));

  return NextResponse.json(members);
}

// POST /api/jam/projects/:id/members - Add member
export async function POST(
  request: NextRequest,
  { params }: { params: { id: string } }
) {
  const { userId, role = 'MEMBER' } = await request.json();

  // Verify requester is admin
  const currentUser = await getCurrentUser(request);
  const isAdmin = await db
    .select()
    .from(projectMembers)
    .where(
      and(
        eq(projectMembers.projectId, params.id),
        eq(projectMembers.userId, currentUser.id),
        eq(projectMembers.role, 'ADMIN')
      )
    )
    .limit(1);

  if (!isAdmin.length) {
    return NextResponse.json(
      { error: 'Only admins can add members' },
      { status: 403 }
    );
  }

  // Check if already a member
  const existing = await db
    .select()
    .from(projectMembers)
    .where(
      and(
        eq(projectMembers.projectId, params.id),
        eq(projectMembers.userId, userId)
      )
    )
    .limit(1);

  if (existing.length) {
    return NextResponse.json(
      { error: 'User is already a team member' },
      { status: 400 }
    );
  }

  // Add member
  const [newMember] = await db.insert(projectMembers).values({
    projectId: params.id,
    userId,
    role,
    joinedAt: new Date(),
    createdAt: new Date(),
  }).returning();

  return NextResponse.json(newMember);
}
```

```typescript
// src/app/api/jam/projects/[id]/members/[userId]/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/db';
import { projectMembers } from '@/db/schema';
import { eq, and } from 'drizzle-orm';

// PATCH /api/jam/projects/:id/members/:userId - Update role
export async function PATCH(
  request: NextRequest,
  { params }: { params: { id: string; userId: string } }
) {
  const { role } = await request.json();

  // Verify requester is admin
  const currentUser = await getCurrentUser(request);
  const isAdmin = await db
    .select()
    .from(projectMembers)
    .where(
      and(
        eq(projectMembers.projectId, params.id),
        eq(projectMembers.userId, currentUser.id),
        eq(projectMembers.role, 'ADMIN')
      )
    )
    .limit(1);

  if (!isAdmin.length) {
    return NextResponse.json(
      { error: 'Only admins can change roles' },
      { status: 403 }
    );
  }

  // Update role
  await db
    .update(projectMembers)
    .set({ role })
    .where(
      and(
        eq(projectMembers.projectId, params.id),
        eq(projectMembers.userId, params.userId)
      )
    );

  return NextResponse.json({ success: true });
}

// DELETE /api/jam/projects/:id/members/:userId - Remove member
export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string; userId: string } }
) {
  const currentUser = await getCurrentUser(request);

  // Allow admin to remove anyone, or user to remove themselves
  const isAdmin = await db
    .select()
    .from(projectMembers)
    .where(
      and(
        eq(projectMembers.projectId, params.id),
        eq(projectMembers.userId, currentUser.id),
        eq(projectMembers.role, 'ADMIN')
      )
    )
    .limit(1);

  const isSelf = currentUser.id === params.userId;

  if (!isAdmin.length && !isSelf) {
    return NextResponse.json(
      { error: 'Not authorized to remove this member' },
      { status: 403 }
    );
  }

  // Remove member
  await db
    .delete(projectMembers)
    .where(
      and(
        eq(projectMembers.projectId, params.id),
        eq(projectMembers.userId, params.userId)
      )
    );

  return NextResponse.json({ success: true });
}
```

## ðŸŽ¯ Testing

1. **Team viewing**
   - All members display with correct roles
   - Join dates show properly
   - Current user badge appears

2. **Add members**
   - Admin can invite users
   - User added to project_members table
   - Cannot add duplicate members

3. **Remove members**
   - Admin can remove any member
   - Members can leave (remove themselves)
   - Cannot remove last admin

4. **Role management**
   - Admin can promote members to admin
   - Admin can demote other admins
   - Role changes persist

## ðŸ’¡ Notes

- Project creator is automatically an ADMIN (via JAM-001 migration)
- Projects must have at least one ADMIN at all times
- Members can see team list but not modify it
- Consider adding invite links/emails in future iteration
- Team size limit could be added later if needed

## ðŸš¨ Potential Issues

- **Last admin protection**: Prevent removing or demoting last admin
- **User lookup**: Need efficient way to find users by email/username
- **Notifications**: Members should be notified when added (future)
- **Permissions cascade**: Removing admin may affect quest submissions
