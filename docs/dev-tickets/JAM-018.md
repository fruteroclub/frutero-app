# JAM-018: PULPA Reward Tracking

**Priority**: üü° Medium  
**Effort**: 2-3 hours  
**Dependencies**: JAM-008 (quest completion)

## üìã Objective

Implement PULPA token reward tracking for participant activities. Track token earnings, display balances, and maintain transparent reward history.

## ‚úÖ Acceptance Criteria

- [ ] PULPA token balance display
- [ ] Reward calculation for activities
- [ ] Transparent reward history
- [ ] Manual reward issuance (admin)
- [ ] Reward notifications
- [ ] Token analytics dashboard

## üõ†Ô∏è Implementation

### Files to Create/Modify

- `src/lib/jam/rewards.ts` - Reward logic
- `src/components/jam-platform/rewards/RewardTracker.tsx`
- `src/app/jam/rewards/page.tsx` - Reward history
- `src/app/api/jam/rewards/route.ts` - Rewards API

### Reward System Configuration

````typescript
// src/lib/jam/rewards.ts
export const REWARD_RATES = {\n  // Quest Completion Rewards\n  quest_completion: {\n    easy: 10,\n    medium: 25,\n    hard: 50\n  },\n  \n  // Project Stage Advancement\n  project_stage: {\n    PROTOTYPE: 100,\n    BUILD: 200,\n    PROJECT: 500\n  },\n  \n  // Community Engagement\n  post_creation: 5,\n  post_popular: 20, // 10+ views\n  \n  // Mentorship\n  session_completion: 15,\n  mentor_rating_high: 25, // 4+ stars\n  \n  // Special Activities\n  program_completion: 100,\n  referral_signup: 50,\n  \n  // Weekly Bonuses\n  weekly_active: 25, // Complete 3+ quests in week\n  perfect_week: 100  // Complete all assigned quests\n};\n\nexport async function awardTokens(\n  userId: string, \n  amount: number, \n  reason: string,\n  sourceId?: string,\n  sourceType?: string\n) {\n  // Create reward record\n  const reward = await db.insert(rewardsTable).values({\n    userId,\n    amount,\n    reason,\n    sourceId,\n    sourceType,\n    createdAt: new Date()\n  }).returning();\n  \n  // Update user balance cache (optional optimization)\n  await updateUserBalance(userId);\n  \n  // Send notification\n  await notifyRewardEarned(userId, amount, reason);\n  \n  return reward[0];\n}\n\nexport async function calculateQuestReward(questId: string): Promise<number> {\n  const quest = await getQuest(questId);\n  return REWARD_RATES.quest_completion[quest.difficulty] || 10;\n}\n\nexport async function calculateWeeklyBonus(userId: string): Promise<number> {\n  const weekStart = startOfWeek(new Date());\n  const weekEnd = endOfWeek(new Date());\n  \n  const weeklyQuests = await db.select()\n    .from(userQuestsTable)\n    .where(\n      and(\n        eq(userQuestsTable.userId, userId),\n        eq(userQuestsTable.status, 'completed'),\n        gte(userQuestsTable.completedAt, weekStart),\n        lte(userQuestsTable.completedAt, weekEnd)\n      )\n    );\n  \n  const assignedQuests = await getAssignedQuestsCount(userId, weekStart, weekEnd);\n  \n  if (weeklyQuests.length >= assignedQuests) {\n    return REWARD_RATES.perfect_week;\n  } else if (weeklyQuests.length >= 3) {\n    return REWARD_RATES.weekly_active;\n  }\n  \n  return 0;\n}\n\nexport async function getUserTokenBalance(userId: string): Promise<number> {\n  const result = await db.select({\n    total: sum(rewardsTable.amount)\n  })\n  .from(rewardsTable)\n  .where(eq(rewardsTable.userId, userId));\n  \n  return result[0]?.total || 0;\n}\n```\n\n### Reward Tracker Component\n\n```tsx\n// src/components/jam-platform/rewards/RewardTracker.tsx\nexport function RewardTracker({ userId }) {\n  const { data: balance } = useQuery({\n    queryKey: ['token-balance', userId],\n    queryFn: () => getTokenBalance(userId)\n  });\n  \n  const { data: recentRewards } = useQuery({\n    queryKey: ['recent-rewards', userId],\n    queryFn: () => getRecentRewards(userId)\n  });\n  \n  return (\n    <Card>\n      <CardHeader>\n        <div className=\"flex items-center justify-between\">\n          <CardTitle className=\"flex items-center gap-2\">\n            <Coins className=\"h-5 w-5\" />\n            PULPA Balance\n          </CardTitle>\n          <Button variant=\"outline\" size=\"sm\" asChild>\n            <Link href=\"/jam/rewards\">\n              View History\n            </Link>\n          </Button>\n        </div>\n      </CardHeader>\n      \n      <CardContent>\n        <div className=\"text-center mb-4\">\n          <div className=\"text-3xl font-bold text-primary\">\n            {balance?.toLocaleString() || 0}\n          </div>\n          <div className=\"text-sm text-foreground\">PULPA Tokens</div>\n        </div>\n        \n        {recentRewards && recentRewards.length > 0 && (\n          <div className=\"space-y-2\">\n            <h4 className=\"font-medium text-sm\">Recent Earnings</h4>\n            {recentRewards.slice(0, 3).map(reward => (\n              <div key={reward.id} className=\"flex justify-between items-center text-sm\">\n                <span className=\"text-foreground\">{reward.reason}</span>\n                <span className=\"font-medium text-green-600\">\n                  +{reward.amount}\n                </span>\n              </div>\n            ))}\n          </div>\n        )}\n        \n        <WeeklyProgress userId={userId} />\n      </CardContent>\n    </Card>\n  );\n}\n\nfunction WeeklyProgress({ userId }) {\n  const { data: weeklyStats } = useQuery({\n    queryKey: ['weekly-progress', userId],\n    queryFn: () => getWeeklyProgress(userId)\n  });\n  \n  if (!weeklyStats) return null;\n  \n  const progress = (weeklyStats.completed / weeklyStats.assigned) * 100;\n  const bonusEligible = weeklyStats.completed >= 3;\n  const perfectWeek = weeklyStats.completed >= weeklyStats.assigned;\n  \n  return (\n    <div className=\"mt-4 p-3 bg-muted/50 rounded-lg\">\n      <div className=\"flex justify-between items-center mb-2\">\n        <span className=\"text-sm font-medium\">Weekly Progress</span>\n        <span className=\"text-xs text-foreground\">\n          {weeklyStats.completed}/{weeklyStats.assigned} quests\n        </span>\n      </div>\n      \n      <Progress value={progress} className=\"mb-2\" />\n      \n      <div className=\"flex justify-between text-xs\">\n        <span className={cn(\n          bonusEligible ? \"text-green-600\" : \"text-foreground\"\n        )}>\n          Active Bonus: +{REWARD_RATES.weekly_active}\n        </span>\n        <span className={cn(\n          perfectWeek ? \"text-green-600\" : \"text-foreground\"\n        )}>\n          Perfect Week: +{REWARD_RATES.perfect_week}\n        </span>\n      </div>\n    </div>\n  );\n}\n```\n\n### Reward History Page\n\n```tsx\n// src/app/jam/rewards/page.tsx\nexport default async function RewardsPage() {\n  const user = await getCurrentUser();\n  const rewards = await getUserRewards(user.id);\n  const stats = await getRewardStats(user.id);\n  \n  return (\n    <div className=\"container py-6\">\n      <div className=\"flex justify-between items-center mb-6\">\n        <h1 className=\"text-3xl font-bold\">PULPA Rewards</h1>\n        <Button variant=\"outline\">\n          <Download className=\"h-4 w-4 mr-2\" />\n          Export History\n        </Button>\n      </div>\n      \n      <div className=\"grid md:grid-cols-3 gap-6 mb-8\">\n        <StatsCard\n          title=\"Total Earned\"\n          value={stats.totalEarned.toLocaleString()}\n          icon={Coins}\n          description=\"All-time PULPA earnings\"\n        />\n        <StatsCard\n          title=\"This Week\"\n          value={stats.weeklyEarned.toLocaleString()}\n          icon={Calendar}\n          description=\"Tokens earned this week\"\n        />\n        <StatsCard\n          title=\"Average/Week\"\n          value={stats.averageWeekly.toLocaleString()}\n          icon={TrendingUp}\n          description=\"Weekly earning average\"\n        />\n      </div>\n      \n      <RewardBreakdown stats={stats} />\n      \n      <Card>\n        <CardHeader>\n          <CardTitle>Reward History</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <RewardTable rewards={rewards} />\n        </CardContent>\n      </Card>\n    </div>\n  );\n}\n\nfunction RewardTable({ rewards }) {\n  return (\n    <Table>\n      <TableHeader>\n        <TableRow>\n          <TableHead>Activity</TableHead>\n          <TableHead>Amount</TableHead>\n          <TableHead>Date</TableHead>\n          <TableHead>Source</TableHead>\n        </TableRow>\n      </TableHeader>\n      <TableBody>\n        {rewards.map(reward => (\n          <TableRow key={reward.id}>\n            <TableCell>{reward.reason}</TableCell>\n            <TableCell className=\"font-medium text-green-600\">\n              +{reward.amount} PULPA\n            </TableCell>\n            <TableCell>\n              {formatDate(reward.createdAt)}\n            </TableCell>\n            <TableCell>\n              {reward.sourceType && (\n                <Badge variant=\"secondary\">\n                  {reward.sourceType}\n                </Badge>\n              )}\n            </TableCell>\n          </TableRow>\n        ))}\n      </TableBody>\n    </Table>\n  );\n}\n```\n\n### Reward Triggers\n\n```typescript\n// Quest completion trigger\nexport async function onQuestCompleted(userId: string, questId: string) {\n  const reward = await calculateQuestReward(questId);\n  await awardTokens(\n    userId,\n    reward,\n    'Quest completion',\n    questId,\n    'quest'\n  );\n  \n  // Check for weekly bonus\n  const weeklyBonus = await calculateWeeklyBonus(userId);\n  if (weeklyBonus > 0) {\n    await awardTokens(\n      userId,\n      weeklyBonus,\n      'Weekly bonus',\n      null,\n      'bonus'\n    );\n  }\n}\n\n// Project stage advancement trigger\nexport async function onProjectStageAdvanced(\n  userId: string, \n  projectId: string, \n  newStage: string\n) {\n  const reward = REWARD_RATES.project_stage[newStage];\n  if (reward) {\n    await awardTokens(\n      userId,\n      reward,\n      `Project advanced to ${newStage}`,\n      projectId,\n      'project'\n    );\n  }\n}\n\n// Post creation trigger\nexport async function onPostCreated(userId: string, postId: string) {\n  await awardTokens(\n    userId,\n    REWARD_RATES.post_creation,\n    'Build in Public post',\n    postId,\n    'post'\n  );\n}\n```\n\n## üéØ Testing\n\n1. **Reward calculation**\n   - Correct amounts awarded\n   - No duplicate rewards\n   - Bonuses calculated properly\n\n2. **Balance tracking**\n   - Balances update correctly\n   - History shows all transactions\n   - Export functionality works\n\n3. **Notifications**\n   - Reward notifications sent\n   - UI updates in real-time\n\n## üí° Notes\n\n- Start with simple point system\n- Consider inflation/deflation mechanisms\n- Add token utility later (marketplace)\n- Track token velocity and distribution\n\n## üö® Potential Issues\n\n- **Double rewards**: Use database constraints\n- **Reward gaming**: Monitor unusual patterns\n- **Balance accuracy**: Use transactions for consistency\n- **Performance**: Cache balances for frequent access
````
