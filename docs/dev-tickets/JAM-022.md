# JAM-022: Team Quest Application & Submission

**Priority**: üî¥ Critical
**Effort**: 4-5 hours
**Dependencies**: JAM-007 (quest system), JAM-021 (team management)

## üìã Objective

Build the team quest application and submission flow. Allow projects (teams) to browse available team quests, apply to quests, track progress, and submit completions for verification.

## ‚úÖ Acceptance Criteria

- [ ] Browse team quests filtered by program participation
- [ ] Apply project to available team quests
- [ ] Track quest progress (0-100%)
- [ ] Submit quest with link and description
- [ ] View submission status (NOT_STARTED ‚Üí SUBMITTED)
- [ ] See quest bounty amounts
- [ ] Check remaining quest slots (maxSubmissions)
- [ ] Only team members can submit for team

## üõ†Ô∏è Implementation

### Files to Create/Modify

- `src/app/jam/projects/[id]/quests/page.tsx` - Project quest dashboard
- `src/app/jam/projects/[id]/quests/[questId]/page.tsx` - Quest detail/submit
- `src/components/jam-platform/quests/TeamQuestCard.tsx` - Team quest card
- `src/components/jam-platform/quests/QuestSubmissionForm.tsx` - Submission form
- `src/app/api/jam/projects/[id]/quests/route.ts` - Quest application API
- `src/app/api/jam/projects/[id]/quests/[questId]/submit/route.ts` - Submission API

### Project Quest Dashboard

```tsx
// src/app/jam/projects/[id]/quests/page.tsx
export default async function ProjectQuestsPage({ params }: { params: { id: string } }) {
  const project = await getProject(params.id)
  const programs = await getProjectPrograms(params.id) // via program_projects
  const availableQuests = await getAvailableTeamQuests(programs)
  const activeQuests = await getProjectQuests(params.id)
  const currentUser = await getCurrentUser()

  const isMember = await isProjectMember(params.id, currentUser.id)

  if (!isMember) {
    return <div>You must be a team member to view quests</div>
  }

  return (
    <div className="container py-6">
      <div className="mb-6">
        <h1 className="text-3xl font-bold">{project.name} - Team Quests</h1>
        <p className="text-foreground">Complete quests to earn bounties for your team</p>
      </div>

      {/* Active Quests */}
      <section className="mb-8">
        <h2 className="mb-4 text-2xl font-semibold">Active Quests</h2>
        {activeQuests.length === 0 ? (
          <Card className="text-foreground p-6 text-center">
            No active quests. Browse available quests below to get started.
          </Card>
        ) : (
          <div className="grid gap-4 md:grid-cols-2">
            {activeQuests.map((pq) => (
              <ProjectQuestCard key={pq.id} projectQuest={pq} projectId={params.id} />
            ))}
          </div>
        )}
      </section>

      {/* Available Quests */}
      <section>
        <h2 className="mb-4 text-2xl font-semibold">Available Quests</h2>
        <QuestFilters programs={programs} />
        <div className="mt-4 grid gap-4 md:grid-cols-2">
          {availableQuests.map((quest) => (
            <TeamQuestCard key={quest.id} quest={quest} projectId={params.id} />
          ))}
        </div>
      </section>
    </div>
  )
}
```

### Team Quest Card

```tsx
// src/components/jam-platform/quests/TeamQuestCard.tsx
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Badge } from '@/components/ui/badge'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Progress } from '@/components/ui/progress'
import { DollarSign, Users, Target } from 'lucide-react'
import Link from 'next/link'

interface TeamQuestCardProps {
  quest: {
    id: string
    title: string
    description: string
    questType: 'INDIVIDUAL' | 'TEAM' | 'BOTH'
    bountyUsd: number | null
    maxSubmissions: number | null
    currentSubmissions: number
  }
  projectId: string
}

export function TeamQuestCard({ quest, projectId }: TeamQuestCardProps) {
  const [applying, setApplying] = useState(false)

  const slotsRemaining = quest.maxSubmissions
    ? quest.maxSubmissions - quest.currentSubmissions
    : null

  const isFull = slotsRemaining !== null && slotsRemaining <= 0

  const handleApply = async () => {
    setApplying(true)
    try {
      await fetch(`/api/jam/projects/${projectId}/quests`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ questId: quest.id }),
      })
      window.location.href = `/jam/projects/${projectId}/quests/${quest.id}`
    } catch (error) {
      console.error('Failed to apply:', error)
      setApplying(false)
    }
  }

  return (
    <Card className={isFull ? 'opacity-60' : ''}>
      <CardHeader>
        <div className="flex items-start justify-between">
          <CardTitle className="text-lg">{quest.title}</CardTitle>
          <div className="flex gap-2">
            {quest.bountyUsd && (
              <Badge variant="default" className="flex items-center gap-1">
                <DollarSign className="h-3 w-3" />${quest.bountyUsd}
              </Badge>
            )}
            <Badge variant="outline">
              <Users className="mr-1 h-3 w-3" />
              {quest.questType}
            </Badge>
          </div>
        </div>
      </CardHeader>

      <CardContent className="space-y-4">
        <p className="text-foreground line-clamp-2 text-sm">{quest.description}</p>

        {slotsRemaining !== null && (
          <div className="space-y-1">
            <div className="flex justify-between text-xs">
              <span>Slots remaining</span>
              <span>
                {slotsRemaining} / {quest.maxSubmissions}
              </span>
            </div>
            <Progress value={(slotsRemaining / quest.maxSubmissions!) * 100} className="h-2" />
          </div>
        )}

        <Button onClick={handleApply} disabled={isFull || applying} className="w-full">
          {isFull ? 'Quest Full' : applying ? 'Applying...' : 'Apply for Quest'}
        </Button>
      </CardContent>
    </Card>
  )
}
```

### Project Quest Card (Active)

```tsx
// src/components/jam-platform/quests/ProjectQuestCard.tsx
'use client'

import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Progress } from '@/components/ui/progress'
import { CheckCircle2, Clock, AlertCircle, XCircle } from 'lucide-react'
import Link from 'next/link'

const statusConfig = {
  NOT_STARTED: { icon: Clock, label: 'Not Started', color: 'default' },
  IN_PROGRESS: { icon: Clock, label: 'In Progress', color: 'default' },
  SUBMITTED: { icon: CheckCircle2, label: 'Submitted', color: 'default' },
  VERIFIED: { icon: CheckCircle2, label: 'Verified', color: 'default' },
  REJECTED: { icon: XCircle, label: 'Rejected', color: 'destructive' },
}

export function ProjectQuestCard({ projectQuest, projectId }) {
  const config = statusConfig[projectQuest.status]
  const Icon = config.icon

  return (
    <Card>
      <CardHeader>
        <div className="flex items-start justify-between">
          <CardTitle className="text-lg">{projectQuest.quest.title}</CardTitle>
          <Badge variant={config.color as any}>
            <Icon className="mr-1 h-3 w-3" />
            {config.label}
          </Badge>
        </div>
      </CardHeader>

      <CardContent className="space-y-4">
        <div className="space-y-2">
          <div className="flex justify-between text-sm">
            <span>Progress</span>
            <span>{projectQuest.progress}%</span>
          </div>
          <Progress value={projectQuest.progress} />
        </div>

        {projectQuest.quest.bountyUsd && (
          <div className="flex items-center justify-between text-sm">
            <span className="text-foreground">Bounty</span>
            <span className="font-semibold">${projectQuest.quest.bountyUsd} USD</span>
          </div>
        )}

        {projectQuest.status === 'VERIFIED' && projectQuest.paidAt && (
          <Badge variant="default" className="w-full justify-center">
            ‚úÖ Paid on {new Date(projectQuest.paidAt).toLocaleDateString()}
          </Badge>
        )}

        <Button asChild className="w-full">
          <Link href={`/jam/projects/${projectId}/quests/${projectQuest.questId}`}>
            {projectQuest.status === 'NOT_STARTED' ? 'Start Quest' : 'View Details'}
          </Link>
        </Button>
      </CardContent>
    </Card>
  )
}
```

### Quest Submission Form

```tsx
// src/components/jam-platform/quests/QuestSubmissionForm.tsx
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'

export function QuestSubmissionForm({
  projectId,
  questId,
  currentSubmission,
}: {
  projectId: string
  questId: string
  currentSubmission?: {
    submissionLink?: string
    submissionText?: string
    progress: number
  }
}) {
  const [submissionLink, setSubmissionLink] = useState(currentSubmission?.submissionLink || '')
  const [submissionText, setSubmissionText] = useState(currentSubmission?.submissionText || '')
  const [progress, setProgress] = useState(currentSubmission?.progress || 0)
  const [loading, setLoading] = useState(false)

  const handleSaveProgress = async () => {
    setLoading(true)
    try {
      await fetch(`/api/jam/projects/${projectId}/quests/${questId}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          progress,
          submissionLink,
          submissionText,
          status: progress === 100 ? 'SUBMITTED' : 'IN_PROGRESS',
        }),
      })
      alert('Progress saved!')
    } catch (error) {
      console.error('Failed to save:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    setLoading(true)
    try {
      await fetch(`/api/jam/projects/${projectId}/quests/${questId}/submit`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          submissionLink,
          submissionText,
        }),
      })
      alert('Quest submitted for verification!')
      window.location.reload()
    } catch (error) {
      console.error('Failed to submit:', error)
    } finally {
      setLoading(false)
    }
  }

  return (
    <Card>
      <CardHeader>
        <CardTitle>Submit Your Work</CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Label htmlFor="progress">Progress</Label>
            <div className="flex items-center gap-4">
              <input
                id="progress"
                type="range"
                min="0"
                max="100"
                value={progress}
                onChange={(e) => setProgress(parseInt(e.target.value))}
                className="flex-1"
              />
              <span className="w-12 text-sm font-semibold">{progress}%</span>
            </div>
          </div>

          <div>
            <Label htmlFor="link">Submission Link</Label>
            <Input
              id="link"
              type="url"
              value={submissionLink}
              onChange={(e) => setSubmissionLink(e.target.value)}
              placeholder="https://github.com/team/project"
              required
            />
            <p className="text-foreground mt-1 text-xs">
              Link to your project, demo, or repository
            </p>
          </div>

          <div>
            <Label htmlFor="text">Description</Label>
            <Textarea
              id="text"
              value={submissionText}
              onChange={(e) => setSubmissionText(e.target.value)}
              placeholder="Describe what you built, challenges faced, and key achievements..."
              rows={6}
              required
            />
          </div>

          <div className="flex gap-2">
            <Button type="button" variant="outline" onClick={handleSaveProgress} disabled={loading}>
              Save Progress
            </Button>
            <Button type="submit" disabled={loading || progress < 100}>
              {loading ? 'Submitting...' : 'Submit for Verification'}
            </Button>
          </div>

          {progress < 100 && (
            <p className="text-foreground text-xs">
              Complete quest (100% progress) to submit for verification
            </p>
          )}
        </form>
      </CardContent>
    </Card>
  )
}
```

### Quest Application API

```typescript
// src/app/api/jam/projects/[id]/quests/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { db } from '@/db'
import { projectQuests, quests, projectMembers } from '@/db/schema'
import { eq, and } from 'drizzle-orm'

// POST /api/jam/projects/:id/quests - Apply to quest
export async function POST(request: NextRequest, { params }: { params: { id: string } }) {
  const { questId } = await request.json()
  const currentUser = await getCurrentUser(request)

  // Verify user is team member
  const membership = await db
    .select()
    .from(projectMembers)
    .where(and(eq(projectMembers.projectId, params.id), eq(projectMembers.userId, currentUser.id)))
    .limit(1)

  if (!membership.length) {
    return NextResponse.json({ error: 'Only team members can apply to quests' }, { status: 403 })
  }

  // Check if already applied
  const existing = await db
    .select()
    .from(projectQuests)
    .where(and(eq(projectQuests.projectId, params.id), eq(projectQuests.questId, questId)))
    .limit(1)

  if (existing.length) {
    return NextResponse.json({ error: 'Project already applied to this quest' }, { status: 400 })
  }

  // Check quest availability
  const [quest] = await db.select().from(quests).where(eq(quests.id, questId)).limit(1)

  if (quest.maxSubmissions) {
    const submissionCount = await db
      .select({ count: sql`count(*)` })
      .from(projectQuests)
      .where(eq(projectQuests.questId, questId))

    if (submissionCount[0].count >= quest.maxSubmissions) {
      return NextResponse.json({ error: 'Quest has reached maximum submissions' }, { status: 400 })
    }
  }

  // Create project quest entry
  const [newProjectQuest] = await db
    .insert(projectQuests)
    .values({
      projectId: params.id,
      questId,
      status: 'NOT_STARTED',
      progress: 0,
      createdAt: new Date(),
      updatedAt: new Date(),
    })
    .returning()

  return NextResponse.json(newProjectQuest)
}
```

```typescript
// src/app/api/jam/projects/[id]/quests/[questId]/submit/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { db } from '@/db'
import { projectQuests, projectMembers } from '@/db/schema'
import { eq, and } from 'drizzle-orm'

// POST /api/jam/projects/:id/quests/:questId/submit - Submit quest
export async function POST(
  request: NextRequest,
  { params }: { params: { id: string; questId: string } },
) {
  const { submissionLink, submissionText } = await request.json()
  const currentUser = await getCurrentUser(request)

  // Verify user is team member
  const membership = await db
    .select()
    .from(projectMembers)
    .where(and(eq(projectMembers.projectId, params.id), eq(projectMembers.userId, currentUser.id)))
    .limit(1)

  if (!membership.length) {
    return NextResponse.json({ error: 'Only team members can submit quests' }, { status: 403 })
  }

  // Update project quest with submission
  await db
    .update(projectQuests)
    .set({
      status: 'SUBMITTED',
      progress: 100,
      submissionLink,
      submissionText,
      submittedAt: new Date(),
      submittedBy: currentUser.id,
      updatedAt: new Date(),
    })
    .where(and(eq(projectQuests.projectId, params.id), eq(projectQuests.questId, params.questId)))

  return NextResponse.json({ success: true })
}
```

## üéØ Testing

1. **Browse quests**
   - Team quests display correctly
   - Bounty amounts shown
   - Quest slots remaining accurate

2. **Apply to quest**
   - Can apply if team member
   - Cannot apply twice
   - Cannot apply if quest full

3. **Progress tracking**
   - Can save progress without submitting
   - Progress slider updates correctly
   - Status changes to IN_PROGRESS

4. **Submit quest**
   - Requires 100% progress
   - Link and text required
   - Status changes to SUBMITTED
   - Submitted by user tracked

## üí° Notes

- Only team members can view/submit quests
- Any team member can submit on behalf of team
- Submission link and text are required
- Progress can be saved incrementally
- Quest appears in "Active Quests" after applying

## üö® Potential Issues

- **Concurrent applications**: Add unique constraint to prevent race conditions
- **Quest availability**: Cache submission counts for performance
- **Large descriptions**: Limit submission text length
- **Link validation**: Consider validating URL format
