# JAM-004: Team-Based Project System

**Priority**: üü° High
**Effort**: 4-5 hours
**Dependencies**: JAM-003 (profile system), JAM-001 (team schema)

## üìã Objective

Build a team-based project system where projects serve as containers for teams. Project admins manage the team, projects can participate in multiple programs, and teams collaborate on quests together.

**Complete rewrite for team support**: Projects are now team containers with multi-program participation.

## ‚úÖ Acceptance Criteria

- [ ] Create project with admin role assignment
- [ ] **Multi-program participation** via program_projects junction
- [ ] **Team treasury wallet** address support
- [ ] Project stages: IDEA ‚Üí PROTOTYPE ‚Üí BUILD ‚Üí PROJECT
- [ ] Shareable project URL (slug generation)
- [ ] Edit project details (admin only)
- [ ] Project displayed on team member profiles
- [ ] **Project admin auto-added to project_members as ADMIN**

## üõ†Ô∏è Implementation

### Files to Create/Modify
- `src/app/jam/projects/create/page.tsx` - Create project flow
- `src/components/jam-platform/projects/ProjectForm.tsx` - Project form
- `src/app/jam/projects/[slug]/page.tsx` - Public project page
- `src/app/api/jam/projects/route.ts` - Project CRUD API
- `src/lib/jam/projects.ts` - Project utilities

### Project Creation Flow

```tsx
// src/app/jam/projects/create/page.tsx
export default async function CreateProjectPage() {
  const currentUser = await getCurrentUser();

  return (
    <div className="container max-w-2xl py-6">
      <div className="mb-6">
        <h1 className="text-3xl font-bold">Create Your Project</h1>
        <p className="text-muted-foreground">
          Start a new project and invite team members to collaborate
        </p>
      </div>

      <ProjectForm userId={currentUser.id} />
    </div>
  );
}
```

### Project Form Component

```tsx
// src/components/jam-platform/projects/ProjectForm.tsx
'use client';

import { useState } from 'react';
import { useRouter } from 'next/navigation';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Textarea } from '@/components/ui/textarea';
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';

export function ProjectForm({
  userId,
  initialData
}: {
  userId: string;
  initialData?: any;
}) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);

  const [formData, setFormData] = useState({
    name: initialData?.name || '',
    description: initialData?.description || '',
    category: initialData?.category || '',
    stage: initialData?.stage || 'IDEA',
    walletAddress: initialData?.walletAddress || '',
    website: initialData?.website || '',
  });

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    try {
      const response = await fetch('/api/jam/projects', {
        method: initialData ? 'PATCH' : 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ...formData,
          adminId: userId, // Creator becomes admin
        }),
      });

      if (response.ok) {
        const project = await response.json();
        router.push(`/jam/projects/${project.slug}`);
      } else {
        const error = await response.json();
        alert(error.message || 'Failed to create project');
      }
    } catch (error) {
      console.error('Failed to create project:', error);
    } finally {
      setLoading(false);
    }
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>
          {initialData ? 'Edit Project' : 'Project Details'}
        </CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Label htmlFor="name">Project Name</Label>
            <Input
              id="name"
              value={formData.name}
              onChange={(e) => setFormData({ ...formData, name: e.target.value })}
              placeholder="Awesome DApp"
              required
              maxLength={100}
            />
          </div>

          <div>
            <Label htmlFor="description">Description</Label>
            <Textarea
              id="description"
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              placeholder="What are you building? (2-3 sentences)"
              required
              maxLength={500}
              rows={4}
            />
          </div>

          <div>
            <Label htmlFor="category">Category</Label>
            <Select
              value={formData.category}
              onValueChange={(value) => setFormData({ ...formData, category: value })}
            >
              <SelectTrigger>
                <SelectValue placeholder="Select category" />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="Web3">Web3/Blockchain</SelectItem>
                <SelectItem value="DeFi">DeFi</SelectItem>
                <SelectItem value="NFT">NFT/Digital Art</SelectItem>
                <SelectItem value="Gaming">Gaming</SelectItem>
                <SelectItem value="Social">Social</SelectItem>
                <SelectItem value="Infrastructure">Infrastructure</SelectItem>
                <SelectItem value="AI">AI/ML</SelectItem>
                <SelectItem value="Other">Other</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div>
            <Label htmlFor="stage">Project Stage</Label>
            <Select
              value={formData.stage}
              onValueChange={(value) => setFormData({ ...formData, stage: value })}
            >
              <SelectTrigger>
                <SelectValue />
              </SelectTrigger>
              <SelectContent>
                <SelectItem value="IDEA">Idea</SelectItem>
                <SelectItem value="PROTOTYPE">Prototype</SelectItem>
                <SelectItem value="BUILD">Building</SelectItem>
                <SelectItem value="PROJECT">Live Project</SelectItem>
              </SelectContent>
            </Select>
          </div>

          <div>
            <Label htmlFor="wallet">Team Wallet Address (Optional)</Label>
            <Input
              id="wallet"
              type="text"
              value={formData.walletAddress}
              onChange={(e) => setFormData({ ...formData, walletAddress: e.target.value })}
              placeholder="0x... (for bounty payments)"
            />
            <p className="text-xs text-muted-foreground mt-1">
              Wallet address for receiving team quest bounties
            </p>
          </div>

          <div>
            <Label htmlFor="website">Website (Optional)</Label>
            <Input
              id="website"
              type="url"
              value={formData.website}
              onChange={(e) => setFormData({ ...formData, website: e.target.value })}
              placeholder="https://yourproject.com"
            />
          </div>

          <Button type="submit" disabled={loading} className="w-full">
            {loading
              ? initialData ? 'Updating...' : 'Creating...'
              : initialData ? 'Update Project' : 'Create Project'}
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}
```

### Project API

```typescript
// src/app/api/jam/projects/route.ts
import { NextRequest, NextResponse } from 'next/server';
import { db } from '@/db';
import { projects, projectMembers } from '@/db/schema';
import { generateSlug } from '@/lib/jam/projects';

// POST /api/jam/projects - Create project
export async function POST(request: NextRequest) {
  const data = await request.json();
  const currentUser = await getCurrentUser(request);

  // Generate unique slug
  const slug = await generateUniqueSlug(data.name);

  // Create project
  const [newProject] = await db.insert(projects).values({
    name: data.name,
    description: data.description,
    category: data.category,
    stage: data.stage || 'IDEA',
    slug,
    adminId: currentUser.id,
    walletAddress: data.walletAddress || null,
    website: data.website || null,
    createdAt: new Date(),
    updatedAt: new Date(),
  }).returning();

  // Auto-add creator as ADMIN member
  await db.insert(projectMembers).values({
    projectId: newProject.id,
    userId: currentUser.id,
    role: 'ADMIN',
    joinedAt: new Date(),
    createdAt: new Date(),
  });

  return NextResponse.json(newProject);
}

// GET /api/jam/projects - List projects
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url);
  const userId = searchParams.get('userId');

  if (userId) {
    // Get projects where user is a member
    const userProjects = await db
      .select({
        project: projects,
        membership: projectMembers,
      })
      .from(projectMembers)
      .innerJoin(projects, eq(projectMembers.projectId, projects.id))
      .where(eq(projectMembers.userId, userId));

    return NextResponse.json(userProjects);
  }

  // Get all projects
  const allProjects = await db.select().from(projects);
  return NextResponse.json(allProjects);
}
```

### Project Display Page

```tsx
// src/app/jam/projects/[slug]/page.tsx
import { notFound } from 'next/navigation';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Users, Calendar, ExternalLink } from 'lucide-react';
import Link from 'next/link';

export default async function ProjectPage({
  params
}: {
  params: { slug: string };
}) {
  const project = await getProjectBySlug(params.slug);

  if (!project) notFound();

  const members = await getProjectMembers(project.id);
  const programs = await getProjectPrograms(project.id);
  const currentUser = await getCurrentUser();

  const isAdmin = members.find(
    m => m.userId === currentUser?.id && m.role === 'ADMIN'
  );

  return (
    <div className="container max-w-4xl py-6">
      {/* Project Header */}
      <div className="flex justify-between items-start mb-6">
        <div>
          <h1 className="text-3xl font-bold mb-2">{project.name}</h1>
          <div className="flex items-center gap-2">
            <Badge>{project.category}</Badge>
            <Badge variant="outline">{project.stage}</Badge>
          </div>
        </div>

        {isAdmin && (
          <Button asChild variant="outline">
            <Link href={`/jam/projects/${project.slug}/edit`}>
              Edit Project
            </Link>
          </Button>
        )}
      </div>

      <div className="grid md:grid-cols-3 gap-6">
        {/* Main Content */}
        <div className="md:col-span-2 space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>About</CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-muted-foreground">{project.description}</p>
            </CardContent>
          </Card>

          {project.website && (
            <Card>
              <CardHeader>
                <CardTitle>Links</CardTitle>
              </CardHeader>
              <CardContent>
                <a
                  href={project.website}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="flex items-center gap-2 text-primary hover:underline"
                >
                  {project.website}
                  <ExternalLink className="h-4 w-4" />
                </a>
              </CardContent>
            </Card>
          )}

          {/* Team Members */}
          <Card>
            <CardHeader>
              <div className="flex justify-between items-center">
                <CardTitle className="flex items-center gap-2">
                  <Users className="h-5 w-5" />
                  Team ({members.length})
                </CardTitle>
                {isAdmin && (
                  <Button size="sm" asChild>
                    <Link href={`/jam/projects/${project.id}/team`}>
                      Manage Team
                    </Link>
                  </Button>
                )}
              </div>
            </CardHeader>
            <CardContent>
              <div className="space-y-2">
                {members.map((member) => (
                  <div key={member.userId} className="flex items-center gap-2">
                    <span>{member.user.displayName}</span>
                    {member.role === 'ADMIN' && (
                      <Badge variant="secondary" className="text-xs">Admin</Badge>
                    )}
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>

        {/* Sidebar */}
        <div className="space-y-4">
          {/* Programs */}
          <Card>
            <CardHeader>
              <CardTitle className="text-base">Programs</CardTitle>
            </CardHeader>
            <CardContent>
              {programs.length === 0 ? (
                <p className="text-sm text-muted-foreground">
                  Not participating in any programs yet
                </p>
              ) : (
                <div className="space-y-2">
                  {programs.map((pp) => (
                    <div key={pp.id} className="text-sm">
                      {pp.program.name}
                      <Badge
                        variant="outline"
                        className="ml-2 text-xs"
                      >
                        {pp.status}
                      </Badge>
                    </div>
                  ))}
                </div>
              )}
              {isAdmin && (
                <Button size="sm" variant="outline" className="w-full mt-3" asChild>
                  <Link href={`/jam/projects/${project.id}/programs`}>
                    Manage Programs
                  </Link>
                </Button>
              )}
            </CardContent>
          </Card>

          {/* Treasury */}
          {project.walletAddress && (
            <Card>
              <CardHeader>
                <CardTitle className="text-base">Team Treasury</CardTitle>
              </CardHeader>
              <CardContent>
                <code className="text-xs break-all">
                  {project.walletAddress}
                </code>
              </CardContent>
            </Card>
          )}

          {/* Created */}
          <Card>
            <CardHeader>
              <CardTitle className="text-base flex items-center gap-2">
                <Calendar className="h-4 w-4" />
                Created
              </CardTitle>
            </CardHeader>
            <CardContent>
              <p className="text-sm">
                {new Date(project.createdAt).toLocaleDateString()}
              </p>
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  );
}
```

### Slug Generation Utility

```typescript
// src/lib/jam/projects.ts
import { db } from '@/db';
import { projects } from '@/db/schema';
import { eq } from 'drizzle-orm';

export function generateSlug(name: string): string {
  return name
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/^-+|-+$/g, '');
}

export async function generateUniqueSlug(name: string): Promise<string> {
  let slug = generateSlug(name);
  let counter = 1;

  while (true) {
    const existing = await db
      .select()
      .from(projects)
      .where(eq(projects.slug, slug))
      .limit(1);

    if (existing.length === 0) {
      return slug;
    }

    slug = `${generateSlug(name)}-${counter}`;
    counter++;
  }
}
```

## üéØ Testing

1. **Project creation**
   - Form validation works
   - Slug is unique and URL-friendly
   - Creator auto-added as ADMIN in project_members
   - Wallet address validation (optional field)

2. **Project viewing**
   - Public page accessible by slug
   - All details displayed correctly
   - Team members listed with roles
   - Programs shown (if any)

3. **Project editing**
   - Only admin can access edit page
   - Changes persist correctly
   - Slug doesn't change on edit

4. **Multi-program participation**
   - Projects can join multiple programs
   - Program list displays on project page
   - See JAM-024 for full program management

5. **Team management**
   - Creator is ADMIN by default
   - Can add more members (see JAM-021)
   - Wallet address for bounty payments

## üí° Notes

- **Projects ARE teams** - No separate teams table
- Slug should be URL-friendly (lowercase, hyphens)
- Keep descriptions concise for display
- Project stages can advance based on quest completion
- Wallet address is optional but recommended for bounty quests
- **Creator automatically becomes ADMIN** via automatic project_members insert
- **Multi-program support** - Projects can participate in multiple programs simultaneously

## üö® Potential Issues

- **Duplicate slugs**: Add random suffix if needed (handled in generateUniqueSlug)
- **Long names**: Truncate slug to reasonable length (handled in generateSlug)
- **Special characters**: Strip from slug generation (handled)
- **Project deletion**: Implement soft delete or archive instead of hard delete
- **Wallet validation**: Validate address format if provided
- **Admin removal**: Prevent removing last ADMIN (see JAM-021)
