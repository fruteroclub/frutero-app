# JAM-024: Program-Project Junction Management

**Priority**: üü° High
**Effort**: 2-3 hours
**Dependencies**: JAM-004 (project system)

## üìã Objective

Build the program-project junction system that allows projects to join multiple programs, track participation status, and manage program completions. This many-to-many relationship enables projects to participate in multiple programs simultaneously.

## ‚úÖ Acceptance Criteria

- [ ] Projects can join multiple programs
- [ ] View all programs a project is participating in
- [ ] Track program status (ACTIVE, COMPLETED, WITHDRAWN)
- [ ] Leave/withdraw from programs
- [ ] Mark program participation as complete
- [ ] Filter quests by program participation

## üõ†Ô∏è Implementation

### Files to Create/Modify

- `src/app/jam/projects/[id]/programs/page.tsx` - Program participation page
- `src/components/jam-platform/programs/ProgramCard.tsx` - Program card
- `src/components/jam-platform/programs/JoinProgramDialog.tsx` - Join modal
- `src/app/api/jam/projects/[id]/programs/route.ts` - Program junction API
- `src/lib/jam/programs.ts` - Program utilities

### Program Participation Page

```tsx
// src/app/jam/projects/[id]/programs/page.tsx
export default async function ProjectProgramsPage({ params }: { params: { id: string } }) {
  const project = await getProject(params.id)
  const activePrograms = await getProjectPrograms(params.id, 'ACTIVE')
  const completedPrograms = await getProjectPrograms(params.id, 'COMPLETED')
  const availablePrograms = await getAvailablePrograms(params.id)
  const currentUser = await getCurrentUser()

  const isAdmin = await isProjectAdmin(params.id, currentUser.id)

  return (
    <div className="container py-6">
      <div className="mb-6 flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold">{project.name} - Programs</h1>
          <p className="text-foreground">Participate in multiple programs to access more quests</p>
        </div>

        {isAdmin && (
          <JoinProgramButton projectId={project.id} availablePrograms={availablePrograms} />
        )}
      </div>

      {/* Active Programs */}
      <section className="mb-8">
        <h2 className="mb-4 text-2xl font-semibold">Active Programs</h2>
        {activePrograms.length === 0 ? (
          <Card className="text-foreground p-6 text-center">
            Not currently participating in any programs.
          </Card>
        ) : (
          <div className="grid gap-4 md:grid-cols-2">
            {activePrograms.map((pp) => (
              <ProgramParticipationCard
                key={pp.id}
                programParticipation={pp}
                projectId={params.id}
                isAdmin={isAdmin}
              />
            ))}
          </div>
        )}
      </section>

      {/* Completed Programs */}
      {completedPrograms.length > 0 && (
        <section>
          <h2 className="mb-4 text-2xl font-semibold">Completed Programs</h2>
          <div className="grid gap-4 md:grid-cols-2">
            {completedPrograms.map((pp) => (
              <ProgramParticipationCard
                key={pp.id}
                programParticipation={pp}
                projectId={params.id}
                isAdmin={isAdmin}
                completed
              />
            ))}
          </div>
        </section>
      )}
    </div>
  )
}
```

### Program Participation Card

```tsx
// src/components/jam-platform/programs/ProgramParticipationCard.tsx
'use client'

import { useState } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import {
  DropdownMenu,
  DropdownMenuContent,
  DropdownMenuItem,
  DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import { Calendar, CheckCircle2, MoreVertical, XCircle } from 'lucide-react'

interface ProgramParticipation {
  id: string
  status: 'ACTIVE' | 'COMPLETED' | 'WITHDRAWN'
  joinedAt: Date
  completedAt?: Date
  program: {
    id: string
    name: string
    description: string
    startDate: Date
    endDate: Date
  }
}

export function ProgramParticipationCard({
  programParticipation,
  projectId,
  isAdmin,
  completed = false,
}: {
  programParticipation: ProgramParticipation
  projectId: string
  isAdmin: boolean
  completed?: boolean
}) {
  const [loading, setLoading] = useState(false)

  const handleMarkComplete = async () => {
    if (!confirm('Mark this program as completed?')) return

    setLoading(true)
    try {
      await fetch(`/api/jam/projects/${projectId}/programs/${programParticipation.program.id}`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: 'COMPLETED' }),
      })
      window.location.reload()
    } catch (error) {
      console.error('Failed to mark complete:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleWithdraw = async () => {
    if (!confirm('Withdraw from this program?')) return

    setLoading(true)
    try {
      await fetch(`/api/jam/projects/${projectId}/programs/${programParticipation.program.id}`, {
        method: 'DELETE',
      })
      window.location.reload()
    } catch (error) {
      console.error('Failed to withdraw:', error)
    } finally {
      setLoading(false)
    }
  }

  return (
    <Card className={completed ? 'opacity-75' : ''}>
      <CardHeader>
        <div className="flex items-start justify-between">
          <div className="flex-1">
            <CardTitle className="text-lg">{programParticipation.program.name}</CardTitle>
            <div className="mt-2 flex items-center gap-2">
              <Badge
                variant={completed ? 'secondary' : 'default'}
                className="flex items-center gap-1"
              >
                {completed ? (
                  <>
                    <CheckCircle2 className="h-3 w-3" />
                    Completed
                  </>
                ) : (
                  'Active'
                )}
              </Badge>
              <span className="text-foreground text-xs">
                Joined {new Date(programParticipation.joinedAt).toLocaleDateString()}
              </span>
            </div>
          </div>

          {isAdmin && !completed && (
            <DropdownMenu>
              <DropdownMenuTrigger asChild>
                <Button variant="ghost" size="sm" disabled={loading}>
                  <MoreVertical className="h-4 w-4" />
                </Button>
              </DropdownMenuTrigger>
              <DropdownMenuContent align="end">
                <DropdownMenuItem onClick={handleMarkComplete}>
                  <CheckCircle2 className="mr-2 h-4 w-4" />
                  Mark as Completed
                </DropdownMenuItem>
                <DropdownMenuItem onClick={handleWithdraw} className="text-destructive">
                  <XCircle className="mr-2 h-4 w-4" />
                  Withdraw from Program
                </DropdownMenuItem>
              </DropdownMenuContent>
            </DropdownMenu>
          )}
        </div>
      </CardHeader>

      <CardContent className="space-y-4">
        <p className="text-foreground text-sm">{programParticipation.program.description}</p>

        <div className="text-foreground flex items-center gap-4 text-xs">
          <div className="flex items-center gap-1">
            <Calendar className="h-3 w-3" />
            <span>
              {new Date(programParticipation.program.startDate).toLocaleDateString()}
              {' - '}
              {new Date(programParticipation.program.endDate).toLocaleDateString()}
            </span>
          </div>
        </div>

        {completed && programParticipation.completedAt && (
          <div className="bg-muted rounded-md p-3">
            <p className="text-xs font-medium">
              Completed on {new Date(programParticipation.completedAt).toLocaleDateString()}
            </p>
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

### Join Program Dialog

```tsx
// src/components/jam-platform/programs/JoinProgramDialog.tsx
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
  DialogTrigger,
} from '@/components/ui/dialog'
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Calendar, Plus } from 'lucide-react'

export function JoinProgramButton({
  projectId,
  availablePrograms,
}: {
  projectId: string
  availablePrograms: any[]
}) {
  const [open, setOpen] = useState(false)
  const [selectedProgram, setSelectedProgram] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)

  const handleJoin = async () => {
    if (!selectedProgram) return

    setLoading(true)
    try {
      const response = await fetch(`/api/jam/projects/${projectId}/programs`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ programId: selectedProgram }),
      })

      if (response.ok) {
        setOpen(false)
        window.location.reload()
      } else {
        const error = await response.json()
        alert(error.message || 'Failed to join program')
      }
    } catch (error) {
      console.error('Failed to join program:', error)
    } finally {
      setLoading(false)
    }
  }

  if (availablePrograms.length === 0) {
    return null
  }

  return (
    <Dialog open={open} onOpenChange={setOpen}>
      <DialogTrigger asChild>
        <Button>
          <Plus className="mr-2 h-4 w-4" />
          Join Program
        </Button>
      </DialogTrigger>
      <DialogContent className="max-w-2xl">
        <DialogHeader>
          <DialogTitle>Join a Program</DialogTitle>
          <DialogDescription>
            Select a program to participate in and access team quests
          </DialogDescription>
        </DialogHeader>

        <div className="max-h-96 space-y-3 overflow-y-auto">
          {availablePrograms.map((program) => (
            <Card
              key={program.id}
              className={`cursor-pointer transition-colors ${
                selectedProgram === program.id
                  ? 'border-primary bg-primary/5'
                  : 'hover:border-muted-foreground/50'
              }`}
              onClick={() => setSelectedProgram(program.id)}
            >
              <CardHeader className="pb-3">
                <CardTitle className="text-base">{program.name}</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-foreground mb-3 text-sm">{program.description}</p>
                <div className="text-foreground flex items-center gap-2 text-xs">
                  <Calendar className="h-3 w-3" />
                  <span>
                    {new Date(program.startDate).toLocaleDateString()}
                    {' - '}
                    {new Date(program.endDate).toLocaleDateString()}
                  </span>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>

        <div className="flex gap-2">
          <Button type="button" variant="outline" onClick={() => setOpen(false)} disabled={loading}>
            Cancel
          </Button>
          <Button onClick={handleJoin} disabled={!selectedProgram || loading}>
            {loading ? 'Joining...' : 'Join Program'}
          </Button>
        </div>
      </DialogContent>
    </Dialog>
  )
}
```

### Program Junction API

```typescript
// src/app/api/jam/projects/[id]/programs/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { db } from '@/db'
import { programProjects, projectMembers } from '@/db/schema'
import { eq, and } from 'drizzle-orm'

// GET /api/jam/projects/:id/programs - List project programs
export async function GET(request: NextRequest, { params }: { params: { id: string } }) {
  const { searchParams } = new URL(request.url)
  const status = searchParams.get('status')

  let query = db.select().from(programProjects).where(eq(programProjects.projectId, params.id))

  if (status) {
    query = query.where(eq(programProjects.status, status))
  }

  const programs = await query
  return NextResponse.json(programs)
}

// POST /api/jam/projects/:id/programs - Join program
export async function POST(request: NextRequest, { params }: { params: { id: string } }) {
  const { programId } = await request.json()
  const currentUser = await getCurrentUser(request)

  // Verify user is admin
  const isAdmin = await db
    .select()
    .from(projectMembers)
    .where(
      and(
        eq(projectMembers.projectId, params.id),
        eq(projectMembers.userId, currentUser.id),
        eq(projectMembers.role, 'ADMIN'),
      ),
    )
    .limit(1)

  if (!isAdmin.length) {
    return NextResponse.json({ error: 'Only project admins can join programs' }, { status: 403 })
  }

  // Check if already participating
  const existing = await db
    .select()
    .from(programProjects)
    .where(and(eq(programProjects.projectId, params.id), eq(programProjects.programId, programId)))
    .limit(1)

  if (existing.length) {
    return NextResponse.json(
      { error: 'Project already participating in this program' },
      { status: 400 },
    )
  }

  // Add program participation
  const [newParticipation] = await db
    .insert(programProjects)
    .values({
      projectId: params.id,
      programId,
      status: 'ACTIVE',
      joinedAt: new Date(),
      createdAt: new Date(),
      updatedAt: new Date(),
    })
    .returning()

  return NextResponse.json(newParticipation)
}
```

```typescript
// src/app/api/jam/projects/[id]/programs/[programId]/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { db } from '@/db'
import { programProjects, projectMembers } from '@/db/schema'
import { eq, and } from 'drizzle-orm'

// PATCH /api/jam/projects/:id/programs/:programId - Update status
export async function PATCH(
  request: NextRequest,
  { params }: { params: { id: string; programId: string } },
) {
  const { status } = await request.json()
  const currentUser = await getCurrentUser(request)

  // Verify user is admin
  const isAdmin = await db
    .select()
    .from(projectMembers)
    .where(
      and(
        eq(projectMembers.projectId, params.id),
        eq(projectMembers.userId, currentUser.id),
        eq(projectMembers.role, 'ADMIN'),
      ),
    )
    .limit(1)

  if (!isAdmin.length) {
    return NextResponse.json(
      { error: 'Only project admins can update program status' },
      { status: 403 },
    )
  }

  // Update status
  const updateData: any = {
    status,
    updatedAt: new Date(),
  }

  if (status === 'COMPLETED') {
    updateData.completedAt = new Date()
  }

  await db
    .update(programProjects)
    .set(updateData)
    .where(
      and(
        eq(programProjects.projectId, params.id),
        eq(programProjects.programId, params.programId),
      ),
    )

  return NextResponse.json({ success: true })
}

// DELETE /api/jam/projects/:id/programs/:programId - Withdraw
export async function DELETE(
  request: NextRequest,
  { params }: { params: { id: string; programId: string } },
) {
  const currentUser = await getCurrentUser(request)

  // Verify user is admin
  const isAdmin = await db
    .select()
    .from(projectMembers)
    .where(
      and(
        eq(projectMembers.projectId, params.id),
        eq(projectMembers.userId, currentUser.id),
        eq(projectMembers.role, 'ADMIN'),
      ),
    )
    .limit(1)

  if (!isAdmin.length) {
    return NextResponse.json(
      { error: 'Only project admins can withdraw from programs' },
      { status: 403 },
    )
  }

  // Mark as withdrawn instead of deleting
  await db
    .update(programProjects)
    .set({
      status: 'WITHDRAWN',
      updatedAt: new Date(),
    })
    .where(
      and(
        eq(programProjects.projectId, params.id),
        eq(programProjects.programId, params.programId),
      ),
    )

  return NextResponse.json({ success: true })
}
```

## üéØ Testing

1. **Join programs**
   - Admin can join multiple programs
   - Cannot join same program twice
   - Non-admins cannot join programs

2. **View participation**
   - All active programs display
   - Completed programs shown separately
   - Join dates accurate

3. **Mark complete**
   - Admin can mark programs complete
   - Completion timestamp recorded
   - Status updates correctly

4. **Withdraw**
   - Admin can withdraw from programs
   - Status changes to WITHDRAWN
   - Withdrawal doesn't delete data

5. **Quest filtering**
   - Quests filtered by program participation
   - Only see quests from joined programs

## üí° Notes

- Projects can participate in unlimited programs
- Only project admins can manage program participation
- Withdrawal doesn't delete data (soft delete via status)
- Program completion is manual (admin-triggered)
- Consider auto-completion based on end date later

## üö® Potential Issues

- **Quest access**: Ensure quests properly filtered by program participation
- **Status transitions**: Validate allowed status transitions
- **Concurrent joins**: Handle race conditions on join
- **Completion criteria**: May want automated completion logic later
