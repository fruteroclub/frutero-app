# JAM-001: Database Schema Migration

**Priority**: üî¥ Critical
**Effort**: 2-3 hours
**Dependencies**: None (start here!)
**Status**: ‚úÖ COMPLETED (commit: 67d9ff5)

## üìã Objective

Migrate the existing database schema to support the Jam platform MVP features with team-based quest support. Add new tables and columns needed for mentorship coordination, team management, quest tracking, and program management.

## ‚úÖ Acceptance Criteria

- [x] Database migrations created and tested
- [x] New `mentorships` table created
- [x] Team-based quest support tables added
- [x] Program-project many-to-many junction created
- [x] Project member management tables added
- [x] Migration runs without errors
- [x] Manual migration script included

## üõ†Ô∏è Implementation

### Files Created/Modified
- `src/db/schema/index.ts` - Complete schema with team support
- `scripts/manual-migration.sql` - Manual SQL migration script
- `src/db/test-schema.ts` - Updated test file for new schema

### Key Schema Changes

#### 1. Mentorships Table
```sql
CREATE TABLE mentorships (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  mentor_id TEXT NOT NULL REFERENCES users(id),
  participant_id TEXT NOT NULL REFERENCES users(id),
  status TEXT DEFAULT 'PENDING',
  session_notes JSONB,
  mentor_rating INTEGER,
  participant_rating INTEGER,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 2. Team-Based Quest Support

**New Enum**:
```sql
CREATE TYPE project_quest_status AS ENUM (
  'NOT_STARTED', 'IN_PROGRESS', 'SUBMITTED', 'VERIFIED', 'REJECTED'
);
```

**Program-Project Junction** (many-to-many):
```sql
CREATE TABLE program_projects (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  program_id UUID NOT NULL REFERENCES programs(id) ON DELETE CASCADE,
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  status TEXT NOT NULL DEFAULT 'ACTIVE',
  joined_at TIMESTAMP NOT NULL DEFAULT NOW(),
  completed_at TIMESTAMP,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE(program_id, project_id)
);
```

**Project Members** (team membership):
```sql
CREATE TABLE project_members (
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  user_id TEXT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  role TEXT NOT NULL DEFAULT 'MEMBER',
  joined_at TIMESTAMP NOT NULL DEFAULT NOW(),
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  PRIMARY KEY (project_id, user_id)
);
```

**Project Quests** (team submissions):
```sql
CREATE TABLE project_quests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
  quest_id UUID NOT NULL REFERENCES quests(id) ON DELETE CASCADE,
  status project_quest_status NOT NULL DEFAULT 'NOT_STARTED',
  progress INTEGER NOT NULL DEFAULT 0,
  submission_link TEXT,
  submission_text TEXT,
  submitted_at TIMESTAMP,
  submitted_by TEXT REFERENCES users(id),
  is_verified BOOLEAN DEFAULT FALSE,
  verified_by TEXT REFERENCES users(id),
  verification_notes TEXT,
  verified_at TIMESTAMP,
  payment_tx_hash TEXT,
  paid_at TIMESTAMP,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW(),
  UNIQUE(project_id, quest_id)
);
```

#### 3. Enhanced Projects Table
```sql
ALTER TABLE projects ADD COLUMN wallet_address TEXT UNIQUE;
-- Removed program_id (migrated to program_projects junction)
```

#### 4. Enhanced Quests Table
```sql
ALTER TABLE quests ADD COLUMN quest_type TEXT NOT NULL DEFAULT 'INDIVIDUAL';
ALTER TABLE quests ADD COLUMN bounty_usd INTEGER;
ALTER TABLE quests ADD COLUMN max_submissions INTEGER;
```

### Migration Steps (Completed)

1. **Updated Drizzle schema** (`src/db/schema/index.ts`)
   - Added all team-based tables and relations
   - Created new enums for project quest status
   - Updated existing table definitions

2. **Created manual migration** (`scripts/manual-migration.sql`)
   - drizzle-kit push had interactive prompts
   - Manual SQL migration bypassed blocking prompts
   - Included data migration for existing program_id relationships

3. **Ran migration**
   ```bash
   psql $DATABASE_URL < scripts/manual-migration.sql
   ```

4. **Updated test file** (`src/db/test-schema.ts`)
   - Fixed references to removed programId field
   - Added programProjects junction insert
   - Verified build passes

## üéØ Testing Results

‚úÖ All migrations applied successfully
‚úÖ No data loss during migration
‚úÖ Build passes with updated schema
‚úÖ Test schema runs without errors

## üí° Implementation Notes

### Architecture Decisions
- **No separate teams table** - Projects serve as team containers
- **Project admin auto-membership** - Creator automatically becomes ADMIN member
- **Many-to-many programs** - Projects can participate in multiple programs
- **Composite primary keys** - projectMembers and projectQuests use composite PKs
- **Manual verification workflow** - Admin reviews ‚Üí verifies/rejects ‚Üí manual payment

### Quest Types
- **INDIVIDUAL** - Single user quest (uses userQuests table)
- **TEAM** - Team quest (uses projectQuests table)
- **BOTH** - Quest available for individual OR team submission

### Verification Workflow
1. Team submits quest via projectQuests.submission_link/text
2. Admin reviews submission
3. Admin verifies (isVerified: true) or rejects (status: REJECTED)
4. If verified, admin manually pays bounty
5. Admin records payment_tx_hash and paid_at

## üö® Issues Encountered & Resolved

### Drizzle-kit Interactive Prompts
**Issue**: `drizzle-kit push` blocked with interactive question about wallet_address
**Solution**: Created manual SQL migration script to bypass interactive prompts
**Files**: `scripts/manual-migration.sql`

### Data Migration
**Issue**: Existing projects had program_id that needed migration
**Solution**: Manual migration script includes INSERT to program_projects from existing data
**Result**: Zero data loss, seamless migration

### Build Errors
**Issue**: test-schema.ts referenced removed programId field
**Solution**: Updated to use programProjects junction table
**Result**: Clean build with no TypeScript errors