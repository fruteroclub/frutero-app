# JAM-007: Quest Management System

**Priority**: ðŸ”´ Critical
**Effort**: 5-6 hours
**Dependencies**: JAM-006 (API structure), JAM-001 (team schema)

## ðŸ“‹ Objective

Build a dual quest system supporting both individual and team-based quests. Individual quests use the userQuests table, while team quests use the projectQuests table for collaborative completion and bounty rewards.

**Updated for team support**: Quests can now be INDIVIDUAL, TEAM, or BOTH types with bounty tracking.

## âœ… Acceptance Criteria

- [ ] Quest listing page with **type filters (INDIVIDUAL/TEAM/BOTH)**
- [ ] Quest detail view with requirements
- [ ] **Quest type badge** (INDIVIDUAL/TEAM/BOTH)
- [ ] **Bounty amount display** for team quests
- [ ] **Max submissions tracking** and remaining slots
- [ ] Progress tracking (0-100%) for both individual and team
- [ ] Quest categories and difficulty levels
- [ ] **Filter by program participation** (team quests)

## ðŸ› ï¸ Implementation

### Files to Create/Modify
- `src/app/jam/quests/page.tsx` - Quest listing
- `src/app/jam/quests/[id]/page.tsx` - Quest details
- `src/components/jam-platform/quests/` - Quest components
- `src/lib/jam/quests.ts` - Quest logic
- `src/app/api/jam/quests/route.ts` - Quest API

### Quest Data Model (Updated)

```typescript
interface Quest {
  id: string;
  title: string;
  description: string;
  category: 'technical' | 'community' | 'learning' | 'project';
  difficulty: 'easy' | 'medium' | 'hard';
  questType: 'INDIVIDUAL' | 'TEAM' | 'BOTH'; // NEW
  bountyUsd: number | null; // NEW - for team quests
  maxSubmissions: number | null; // NEW - quest capacity
  rewardPoints: number;
  availableFrom: Date;
  dueDate: Date;
  requirements: string[];
  deliverables: string[];
}

// Individual quest submission
interface UserQuest {
  id: string;
  userId: string;
  questId: string;
  status: 'not_started' | 'in_progress' | 'completed';
  progress: number; // 0-100
  startedAt?: Date;
  completedAt?: Date;
}

// Team quest submission (NEW)
interface ProjectQuest {
  id: string;
  projectId: string;
  questId: string;
  status: 'NOT_STARTED' | 'IN_PROGRESS' | 'SUBMITTED' | 'VERIFIED' | 'REJECTED';
  progress: number; // 0-100
  submissionLink?: string;
  submissionText?: string;
  submittedAt?: Date;
  submittedBy?: string; // User who submitted
  isVerified: boolean;
  verifiedBy?: string; // Admin who verified
  paymentTxHash?: string; // Bounty payment
  paidAt?: Date;
}
```

### Quest Listing Page (Updated)

```tsx
// src/app/jam/quests/page.tsx
export default async function QuestsPage({
  searchParams
}: {
  searchParams: { type?: string; programId?: string };
}) {
  const user = await getCurrentUser();
  const typeFilter = searchParams.type || 'ALL';

  // Get both individual and team quests
  const individualQuests = await getUserQuests(user.id);
  const userProjects = await getUserProjects(user.id);
  const teamQuests = await getTeamQuestsForProjects(userProjects.map(p => p.id));

  // Filter by type
  let quests = [...individualQuests, ...teamQuests];
  if (typeFilter !== 'ALL') {
    quests = quests.filter(q =>
      q.questType === typeFilter || q.questType === 'BOTH'
    );
  }

  return (
    <div className="container py-6">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-3xl font-bold">Your Quests</h1>
        <QuestTypeToggle currentType={typeFilter} />
      </div>

      <QuestFilters />

      <div className="grid gap-4 mt-6">
        <QuestSection
          title="Active"
          quests={quests.filter(q => q.status === 'in_progress' || q.status === 'IN_PROGRESS')}
          highlight
        />
        <QuestSection
          title="Available"
          quests={quests.filter(q => q.status === 'not_started' || q.status === 'NOT_STARTED')}
        />
        <QuestSection
          title="Completed"
          quests={quests.completed}
          collapsed
        />
      </div>
    </div>
  );
}
```

### Quest Type Toggle Component (NEW)

```tsx
// src/components/jam-platform/quests/QuestTypeToggle.tsx
'use client';

export function QuestTypeToggle({ currentType }: { currentType: string }) {
  return (
    <div className="flex gap-2">
      <Link href="/jam/quests?type=ALL">
        <Button variant={currentType === 'ALL' ? 'default' : 'outline'} size="sm">
          All Quests
        </Button>
      </Link>
      <Link href="/jam/quests?type=INDIVIDUAL">
        <Button variant={currentType === 'INDIVIDUAL' ? 'default' : 'outline'} size="sm">
          Individual
        </Button>
      </Link>
      <Link href="/jam/quests?type=TEAM">
        <Button variant={currentType === 'TEAM' ? 'default' : 'outline'} size="sm">
          Team
        </Button>
      </Link>
    </div>
  );
}
```

### Quest Card Component (Updated)

```tsx
// src/components/jam-platform/quests/QuestCard.tsx
export function QuestCard({ quest, userQuest, projectQuest, projectName }) {
  const isTeamQuest = quest.questType === 'TEAM' || (quest.questType === 'BOTH' && projectQuest);
  const submission = isTeamQuest ? projectQuest : userQuest;

  return (
    <Card className="hover:shadow-lg transition-shadow">
      <CardHeader>
        <div className="flex justify-between items-start">
          <div>
            <CardTitle>{quest.title}</CardTitle>
            <div className="flex gap-2 mt-2">
              {/* Quest Type Badge (NEW) */}
              <Badge variant={quest.questType === 'TEAM' ? 'default' : 'secondary'}>
                {quest.questType}
              </Badge>

              <Badge variant="outline">{quest.category}</Badge>
              <Badge variant={getDifficultyVariant(quest.difficulty)}>
                {quest.difficulty}
              </Badge>
              <Badge variant="secondary">
                {quest.rewardPoints} points
              </Badge>

              {/* Bounty Badge (NEW) */}
              {quest.bountyUsd && (
                <Badge variant="default" className="bg-green-600">
                  ${quest.bountyUsd} USD
                </Badge>
              )}
            </div>

            {/* Team Quest Project Name (NEW) */}
            {isTeamQuest && projectName && (
              <p className="text-sm text-muted-foreground mt-1">
                Team: {projectName}
              </p>
            )}
          </div>
          <QuestStatus status={submission?.status || 'not_started'} />
        </div>
      </CardHeader>

      <CardContent>
        <p className="text-muted-foreground mb-4">
          {quest.description}
        </p>

        {/* Max Submissions Tracking (NEW) */}
        {quest.maxSubmissions && (
          <div className="text-sm text-muted-foreground mb-2">
            Remaining slots: {quest.maxSubmissions - quest.currentSubmissions} / {quest.maxSubmissions}
          </div>
        )}

        {submission && (
          <div className="space-y-2">
            <div className="flex justify-between text-sm">
              <span>Progress</span>
              <span>{submission.progress}%</span>
            </div>
            <Progress value={submission.progress} />
          </div>
        )}

        <div className="flex justify-between items-center mt-4">
          <span className="text-sm text-muted-foreground">
            Due {formatDate(quest.dueDate)}
          </span>
          <Button asChild>
            <Link href={`/jam/quests/${quest.id}`}>
              View Details
            </Link>
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
```

### Quest Assignment Logic

```typescript
// src/lib/jam/quests.ts
export async function assignWeeklyQuests(userId: string) {
  const user = await getUserWithProfile(userId);
  const currentWeek = getCurrentProgramWeek();
  
  // Get quests for user's track and current week
  const quests = await db.select()
    .from(questsTable)
    .where(
      and(
        eq(questsTable.week, currentWeek),
        or(
          eq(questsTable.track, user.track),
          eq(questsTable.track, 'all')
        )
      )
    );
  
  // Assign quests to user
  for (const quest of quests) {
    await db.insert(userQuestsTable)
      .values({
        userId,
        questId: quest.id,
        status: 'not_started',
        progress: 0
      })
      .onConflictDoNothing();
  }
}

export function getQuestFilters() {
  return {
    status: ['not_started', 'in_progress', 'completed'],
    category: ['technical', 'community', 'learning', 'project'],
    difficulty: ['easy', 'medium', 'hard'],
    week: ['current', 'upcoming', 'past']
  };
}
```

### Quest Detail Page (Updated)

```tsx
// src/app/jam/quests/[id]/page.tsx
export default async function QuestDetailPage({
  params,
  searchParams
}: {
  params: { id: string };
  searchParams: { projectId?: string };
}) {
  const user = await getCurrentUser();
  const quest = await getQuest(params.id);

  // Support both individual and team quest views
  const isTeamQuest = quest.questType === 'TEAM' || searchParams.projectId;

  let submission;
  let project;

  if (isTeamQuest && searchParams.projectId) {
    project = await getProject(searchParams.projectId);
    submission = await getProjectQuest(searchParams.projectId, params.id);
  } else {
    submission = await getUserQuest(user.id, params.id);
  }

  return (
    <div className="container max-w-4xl py-6">
      <QuestHeader
        quest={quest}
        projectName={project?.name}
        isTeamQuest={isTeamQuest}
      />

      <div className="grid md:grid-cols-3 gap-6 mt-6">
        <div className="md:col-span-2 space-y-6">
          <QuestRequirements requirements={quest.requirements} />
          <QuestDeliverables deliverables={quest.deliverables} />

          {/* Different submission form based on quest type */}
          {isTeamQuest ? (
            <TeamQuestSubmissionForm
              questId={quest.id}
              projectId={searchParams.projectId!}
              currentSubmission={submission}
            />
          ) : (
            <QuestSubmissionForm
              questId={quest.id}
              currentSubmission={submission}
            />
          )}
        </div>

        <div className="space-y-4">
          <QuestProgress submission={submission} />
          <QuestRewards
            points={quest.rewardPoints}
            bountyUsd={quest.bountyUsd}
            isTeamQuest={isTeamQuest}
          />
          <QuestDeadline dueDate={quest.dueDate} />

          {/* Max submissions info (NEW) */}
          {quest.maxSubmissions && (
            <QuestCapacity
              maxSubmissions={quest.maxSubmissions}
              currentSubmissions={quest.currentSubmissions}
            />
          )}
        </div>
      </div>
    </div>
  );
}
```

## ðŸŽ¯ Testing

1. **Quest display**
   - All assigned quests show (both individual and team)
   - Type filters work (ALL/INDIVIDUAL/TEAM/BOTH)
   - Quest type badges display correctly
   - Bounty amounts show for team quests
   - Max submissions tracking visible
   - Status badges accurate

2. **Quest assignment**
   - Weekly individual quests auto-assigned
   - Team quests available for projects in programs
   - Track-specific quests work
   - No duplicate assignments

3. **Progress tracking**
   - Progress updates save for both individual and team
   - Status changes work correctly
   - Completion triggers rewards
   - Team submission workflow (IN_PROGRESS â†’ SUBMITTED â†’ VERIFIED)

4. **Team quest workflow**
   - Projects can apply to team quests
   - Submission requires 100% progress
   - Submission link and text captured
   - Bounty tracking works (verification â†’ payment)

## ðŸ’¡ Notes

- Pre-populate quests in database seed with varied types (INDIVIDUAL/TEAM/BOTH)
- Team quests only visible to projects participating in relevant programs
- Consider quest dependencies later (prerequisites)
- Weekly assignment could be cron job
- Cache quest data for performance
- **Individual vs Team**: Users see individual quests by default, team quests when viewing from project context
- **Quest capacity**: Track `currentSubmissions` to prevent exceeding `maxSubmissions`

## ðŸš¨ Potential Issues

- **Time zones**: Use UTC for consistency
- **Quest availability**: Check dates carefully and program participation
- **Progress validation**: Ensure 0-100 range for both individual and team
- **Duplicate assignments**: Use unique constraints (userId+questId, projectId+questId)
- **Quest capacity**: Prevent applying when maxSubmissions reached
- **Team permissions**: Only team members can submit team quests
- **Bounty payments**: Manual verification required before bounty released