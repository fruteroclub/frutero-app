# JAM-008: Quest Submission & Progress Tracking

**Priority**: üî¥ Critical  
**Effort**: 3-4 hours  
**Dependencies**: JAM-007 (quest system)  

## üìã Objective

Enable participants to submit proof-of-work for quests and track their progress. This creates the accountability loop that drives program completion.

## ‚úÖ Acceptance Criteria

- [ ] Quest submission form with file/link uploads
- [ ] Progress percentage updates
- [ ] Submission history tracking
- [ ] Auto-completion at 100% progress
- [ ] Mentor review notifications
- [ ] Submission stored with timestamps

## üõ†Ô∏è Implementation

### Files to Create/Modify
- `src/components/jam-platform/quests/QuestSubmissionForm.tsx`
- `src/app/api/jam/quests/[id]/submit/route.ts`
- `src/lib/jam/submissions.ts` - Submission logic
- `src/components/jam-platform/quests/SubmissionHistory.tsx`

### Submission Form

```tsx
// src/components/jam-platform/quests/QuestSubmissionForm.tsx
export function QuestSubmissionForm({ questId, currentProgress = 0 }) {
  const [progress, setProgress] = useState(currentProgress);
  const [submissionText, setSubmissionText] = useState('');
  const [links, setLinks] = useState<string[]>(['']);
  
  const handleSubmit = async (e) => {
    e.preventDefault();
    
    const submission = {
      questId,
      progress,
      submissionText,
      submissionUrls: links.filter(l => l.trim())
    };
    
    await submitQuestProgress(submission);
    toast.success('Progress submitted successfully!');
    router.refresh();
  };
  
  return (
    <Card>
      <CardHeader>
        <CardTitle>Submit Progress</CardTitle>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <Label>Progress Completed</Label>
            <div className="flex items-center gap-4">
              <Slider
                value={[progress]}
                onValueChange={([v]) => setProgress(v)}
                max={100}
                step={10}
                className="flex-1"
              />
              <span className="w-12 text-right">{progress}%</span>
            </div>
          </div>
          
          <div>
            <Label>Description of Work</Label>
            <Textarea
              value={submissionText}
              onChange={(e) => setSubmissionText(e.target.value)}
              placeholder="What did you accomplish? What did you learn?"
              rows={4}
              required
            />
          </div>
          
          <div>
            <Label>Proof of Work (Links)</Label>
            <div className="space-y-2">
              {links.map((link, i) => (
                <div key={i} className="flex gap-2">
                  <Input
                    type="url"
                    value={link}
                    onChange={(e) => updateLink(i, e.target.value)}
                    placeholder="GitHub, demo, screenshot, etc."
                  />
                  {links.length > 1 && (
                    <Button
                      type="button"
                      variant="ghost"
                      size="icon"
                      onClick={() => removeLink(i)}
                    >
                      <X className="h-4 w-4" />
                    </Button>
                  )}
                </div>
              ))}
              <Button
                type="button"
                variant="outline"
                size="sm"
                onClick={addLink}
              >
                <Plus className="h-4 w-4 mr-2" />
                Add Link
              </Button>
            </div>
          </div>
          
          <Button type="submit" className="w-full">
            Submit Progress Update
          </Button>
        </form>
      </CardContent>
    </Card>
  );
}
```

### Submission API

```typescript
// src/app/api/jam/quests/[id]/submit/route.ts
export const POST = withAuth(async (request: Request, { params }) => {
  const questId = params.id;
  const userId = request.user.id;
  const data = await request.json();
  
  // Validate submission
  if (data.progress < 0 || data.progress > 100) {
    throw new ValidationError('Progress must be between 0 and 100');
  }
  
  // Get current quest status
  const userQuest = await db.select()
    .from(userQuestsTable)
    .where(
      and(
        eq(userQuestsTable.questId, questId),
        eq(userQuestsTable.userId, userId)
      )
    )
    .limit(1);
    
  if (!userQuest[0]) {
    throw new NotFoundError('Quest not found for user');
  }
  
  if (userQuest[0].status === 'completed') {
    throw new ConflictError('Quest already completed');
  }
  
  // Update quest progress
  const newStatus = data.progress === 100 ? 'completed' : 'in_progress';
  
  await db.update(userQuestsTable)
    .set({
      progress: data.progress,
      status: newStatus,
      submissionText: data.submissionText,
      submissionUrls: data.submissionUrls,
      updatedAt: new Date(),
      completedAt: newStatus === 'completed' ? new Date() : null
    })
    .where(
      and(
        eq(userQuestsTable.questId, questId),
        eq(userQuestsTable.userId, userId)
      )
    );
  
  // Create submission record for history
  await db.insert(submissionsTable).values({
    userQuestId: userQuest[0].id,
    progress: data.progress,
    description: data.submissionText,
    links: data.submissionUrls,
    submittedAt: new Date()
  });
  
  // Notify mentor if completed
  if (newStatus === 'completed') {
    await notifyMentorOfCompletion(userId, questId);
  }
  
  // Award points if completed
  if (newStatus === 'completed' && !userQuest[0].completedAt) {
    await awardQuestPoints(userId, questId);
  }
  
  return successResponse({
    progress: data.progress,
    status: newStatus
  }, 'Progress updated successfully');
});
```

### Submission History

```tsx
// src/components/jam-platform/quests/SubmissionHistory.tsx
export function SubmissionHistory({ questId }) {
  const submissions = useSubmissionHistory(questId);
  
  return (
    <Card>
      <CardHeader>
        <CardTitle>Submission History</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-4">
          {submissions.map((submission) => (
            <div key={submission.id} className="border-l-2 pl-4">
              <div className="flex justify-between items-start">
                <div>
                  <p className="font-medium">
                    {submission.progress}% Progress
                  </p>
                  <p className="text-sm text-muted-foreground">
                    {submission.description}
                  </p>
                  {submission.links.length > 0 && (
                    <div className="flex gap-2 mt-2">
                      {submission.links.map((link, i) => (
                        <Link
                          key={i}
                          href={link}
                          target="_blank"
                          className="text-sm text-blue-500 hover:underline"
                        >
                          Link {i + 1}
                        </Link>
                      ))}
                    </div>
                  )}
                </div>
                <span className="text-sm text-muted-foreground">
                  {formatRelativeTime(submission.submittedAt)}
                </span>
              </div>
            </div>
          ))}
        </div>
      </CardContent>
    </Card>
  );
}
```

### Progress Tracking Utilities

```typescript
// src/lib/jam/submissions.ts
export async function checkProjectStageAdvancement(userId: string) {
  const completedQuests = await db.select()
    .from(userQuestsTable)
    .where(
      and(
        eq(userQuestsTable.userId, userId),
        eq(userQuestsTable.status, 'completed')
      )
    );
    
  const project = await getUserProject(userId);
  const currentStage = project.stage;
  const stageRequirements = PROJECT_STAGES[currentStage];
  
  if (completedQuests.length >= stageRequirements.requiredQuests) {
    await advanceProjectStage(project.id);
    await notifyUserOfStageAdvancement(userId, stageRequirements.next);
  }
}

export async function calculateOverallProgress(userId: string) {
  const stats = await db.select({
    total: count(),
    completed: sum(
      case(eq(userQuestsTable.status, 'completed'), 1, 0)
    )
  })
  .from(userQuestsTable)
  .where(eq(userQuestsTable.userId, userId));
  
  return {
    percentage: (stats.completed / stats.total) * 100,
    completed: stats.completed,
    total: stats.total
  };
}
```

## üéØ Testing

1. **Submission flow**
   - Form validates input
   - Progress updates correctly
   - Links saved properly

2. **Completion logic**
   - 100% marks as complete
   - Points awarded once
   - Mentor notified

3. **History tracking**
   - All submissions shown
   - Timestamps accurate
   - Links functional

## üí° Notes

- Store submissions for audit trail
- Consider file uploads later (use R2)
- Mentor review could be async
- Progress slider is user-friendly

## üö® Potential Issues

- **Duplicate submissions**: Throttle/debounce
- **Link validation**: Basic URL check only
- **Progress regression**: Allow going backwards?
- **Concurrent updates**: Use transactions