# JAM-002: Privy Authentication Integration

**Priority**: üî¥ Critical
**Effort**: 3-4 hours
**Dependencies**: JAM-001 (database ready)
**Status**: ‚úÖ COMPLETED

## üìã Objective

Integrate Privy authentication to enable wallet and email-based login for the Jam platform. This is the gateway to all platform features.

**Note**: Originally planned for Para, switched to Privy for better wallet support and developer experience.

## ‚úÖ Acceptance Criteria

- [x] Privy SDK integrated and configured
- [x] Login with wallet/email/social options
- [x] User session management working
- [x] User creation in database on first login (DID format)
- [x] Logout functionality
- [x] Protected routes working

## üõ†Ô∏è Implementation

### Files Created/Modified
- `src/providers/auth/privy-provider.tsx` - Privy provider wrapper
- `src/components/buttons/auth-button-privy.tsx` - Privy login button
- `src/app/api/users/route.ts` - User API for creating users on first login
- `src/hooks/use-auth.ts` - Custom auth hook
- `.env.local` - Added `NEXT_PUBLIC_PRIVY_APP_ID`

### Privy Provider Setup

```typescript
// src/providers/auth/privy-provider.tsx
'use client';

import { PrivyProvider } from '@privy-io/react-auth';
import { base } from 'viem/chains';

export function AuthProvider({ children }: { children: React.ReactNode }) {
  return (
    <PrivyProvider
      appId={process.env.NEXT_PUBLIC_PRIVY_APP_ID!}
      config={{
        loginMethods: ['wallet', 'email', 'google', 'twitter'],
        appearance: {
          theme: 'dark',
          accentColor: '#676FFF',
        },
        defaultChain: base,
        supportedChains: [base],
      }}
    >
      {children}
    </PrivyProvider>
  );
}
```

### Login Button Component

```tsx
// src/components/buttons/auth-button-privy.tsx
'use client';

import { usePrivy } from '@privy-io/react-auth';
import { Button } from '@/components/ui/button';

export function AuthButtonPrivy() {
  const { ready, authenticated, login, logout } = usePrivy();

  if (!ready) {
    return <Button disabled>Loading...</Button>;
  }

  if (authenticated) {
    return (
      <Button onClick={logout} variant="outline">
        Disconnect
      </Button>
    );
  }

  return <Button onClick={login}>Connect Wallet</Button>;
}
```

### User Creation API

```typescript
// src/app/api/users/route.ts
export async function POST(request: Request) {
  const { privyDid } = await request.json();

  // Check if user exists
  const existingUser = await db
    .select()
    .from(users)
    .where(eq(users.id, privyDid))
    .limit(1);

  if (existingUser.length > 0) {
    return NextResponse.json(existingUser[0]);
  }

  // Create new user with Privy DID
  const [newUser] = await db.insert(users).values({
    id: privyDid, // Format: did:privy:...
    displayName: 'New User',
    createdAt: new Date(),
    updatedAt: new Date(),
  }).returning();

  return NextResponse.json(newUser);
}
```

### Custom Auth Hook

```typescript
// src/hooks/use-auth.ts
import { usePrivy } from '@privy-io/react-auth';

export function useAuth() {
  const { ready, authenticated, user } = usePrivy();

  return {
    isAuthenticated: authenticated,
    isLoading: !ready,
    user: user ? {
      id: user.id, // Privy DID format: did:privy:...
      wallet: user.wallet?.address,
      email: user.email?.address,
    } : null,
  };
}
```

## üéØ Testing Results

‚úÖ **Wallet connection**
   - MetaMask tested and working
   - WalletConnect integration functional
   - User automatically created in DB on first login

‚úÖ **Email login**
   - Email verification working
   - Magic link authentication functional
   - Session persists across page refreshes

‚úÖ **Multiple login methods**
   - Google OAuth working
   - Twitter OAuth working
   - Email and wallet options available

‚úÖ **Database integration**
   - Users created with Privy DID format (`did:privy:...`)
   - Schema supports TEXT for id field (compatible with DID format)
   - No UUID conflicts

## üí° Implementation Notes

### Why Privy over Para?
- **Better wallet support** - More wallet options out of the box
- **Social login** - Google, Twitter, Discord built-in
- **Developer experience** - Simpler SDK, better documentation
- **Base L2 support** - Native support for Base chain
- **Free tier** - Better for MVP development

### DID Format
Privy uses Decentralized Identifier (DID) format:
```
did:privy:clp1234567890abcdef
```

This is stored in `users.id` field (TEXT type, not UUID).

### User Creation Flow
1. User authenticates via Privy (wallet/email/social)
2. Frontend receives Privy user object with DID
3. Frontend calls POST `/api/users` with privyDid
4. Backend checks if user exists
5. If new user ‚Üí create in DB with DID as id
6. Return user object to frontend

### Session Management
- Privy handles session tokens automatically
- Session persists in localStorage
- Auto-refresh on page load
- Logout clears Privy session

## üö® Issues Encountered & Resolved

### Schema Compatibility
**Issue**: Users table initially had UUID type for id field
**Solution**: Changed to TEXT type in JAM-001 migration to support DID format
**Result**: Seamless user creation with Privy DIDs

### Build Configuration
**Issue**: Privy requires client-side rendering
**Solution**: All auth components use `'use client'` directive
**Result**: Clean build with no SSR conflicts

### Environment Variables
**Issue**: Need Privy App ID from dashboard
**Solution**: Added `NEXT_PUBLIC_PRIVY_APP_ID` to `.env.local`
**Result**: Authentication working in development